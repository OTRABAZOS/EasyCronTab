<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> ‚Äì Gestor de crontab</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header class="header">
    <h1>üïí EasyCronTab</h1>
    <nav>
      <a href="/">Inicio</a>
      <a href="#schedule">Schedule</a>
      <a href="#tareas">Gestionar</a>
      <a href="#pm2">PM2</a>
      <a href="#config">Configuraci√≥n</a>
    </nav>
  </header>

  <main class="main-content">
    <div class="intro-card">
      <p class="intro intro-lead">üöÄ Crea y edita tareas programadas sin tocar comandos de Linux: elige frecuencia (cada X minutos, diario, semanal‚Ä¶), la hora y el comando a ejecutar. Tambi√©n puedes buscar tareas en lenguaje natural.</p>
    </div>

    <!-- Buscador: resultados clickeables (Editar/Eliminar); al buscar solo se muestran esos resultados -->
    <section class="search-section card-section">
      <h2><span class="section-emoji" aria-hidden="true">üîç</span> Buscar tareas</h2>
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Ej: cron de ara√±as, pr√≥ximas horas, backup..." autocomplete="off">
      </div>
      <div class="search-tip" aria-label="Ayuda de b√∫squeda">
        <p>Escribe para buscar. Los resultados se pueden editar o eliminar.</p>
        <p>Los resultados aparecer√°n aqu√≠ cuando busques.</p>
      </div>
      <div class="search-results" id="search-results" aria-live="polite"></div>
      <p class="search-ver-todas" id="search-ver-todas" style="display: none; margin-top: 0.5rem;">
        <button type="button" class="btn btn-small btn-edit" id="btn-ver-todas">Ver todas las tareas</button>
      </p>
    </section>

    <!-- Schedule: todas las tareas ordenadas por pr√≥xima ejecuci√≥n -->
    <section class="schedule-section card-section" id="schedule">
      <h2><span class="section-emoji" aria-hidden="true">üìÖ</span> Tareas por pr√≥xima ejecuci√≥n</h2>
      <p class="intro">Todas las tareas ordenadas por la pr√≥xima vez que se ejecutar√°n. Puedes editar o eliminar desde aqu√≠ o desde la b√∫squeda.</p>
      <ul class="jobs-list" id="schedule-list"></ul>
      <p class="no-jobs" id="no-jobs">No hay tareas. A√±ade una con el bot√≥n de abajo.</p>
    </section>

    <!-- Tareas: acciones y formulario -->
    <section class="tasks-section card-section" id="tareas">
      <h2><span class="section-emoji" aria-hidden="true">‚öôÔ∏è</span> Gestionar tareas</h2>
      <% if (typeof crontabError !== 'undefined' && crontabError) { %>
        <p class="error-message">Error al leer crontab: <%= crontabError %></p>
      <% } %>

      <div class="form-actions" style="margin-bottom: 1rem;">
        <button type="button" class="btn btn-primary" id="btn-add-job">A√±adir tarea</button>
        <button type="button" class="btn btn-primary" id="btn-add-from-repo">A√±adir desde repositorio</button>
        <button type="button" class="btn btn-primary" id="btn-save-crontab">Guardar crontab</button>
        <span id="save-status" class="status"></span>
      </div>

      <div class="how-to-repos" aria-label="C√≥mo programar tareas con tus repos">
        <p><strong>¬øC√≥mo uso la carpeta de repos para programar tareas?</strong></p>
        <ol>
          <li>Pulsa <strong>A√±adir desde repositorio</strong>.</li>
          <li>Si hace falta, elige la carpeta con <strong>Buscar carpeta</strong> y <strong>Guardar ruta</strong>.</li>
          <li>Elige un <strong>repositorio</strong> en el desplegable (proyectos con <code>package.json</code>).</li>
          <li>Elige el <strong>script</strong> a ejecutar (npm start, npm run build, etc.) y pulsa <strong>Usar este comando y definir horario</strong>.</li>
          <li>En el formulario que se abre, define <strong>frecuencia y hora</strong> y guarda la tarea.</li>
          <li>Por √∫ltimo, pulsa <strong>Guardar crontab</strong> para escribir los cambios en el sistema.</li>
        </ol>
      </div>

      <!-- Panel: elegir repo + script para rellenar comando -->
      <div class="job-form-panel repo-picker-panel" id="repo-picker-panel" style="display: none;">
        <h3><span class="section-emoji" aria-hidden="true">üì¶</span> A√±adir desde repositorio</h3>
        <p class="intro">Elige un repositorio y un script (npm start, npm run ‚Ä¶). Se rellenar√° el comando y podr√°s definir la frecuencia.</p>
        <div class="form-row">
          <label for="repo-picker-path">Carpeta de repositorios</label>
          <div class="path-input-row">
            <input type="text" id="repo-picker-path" placeholder="/ruta/a/mis/repos" value="<%= typeof reposPath !== 'undefined' ? reposPath : '' %>" readonly>
            <button type="button" class="btn btn-primary" id="repo-picker-browse">Buscar carpeta</button>
          </div>
          <button type="button" class="btn btn-small btn-edit" id="repo-picker-save-path">Guardar ruta</button>
          <span id="repo-picker-path-status" class="status"></span>
        </div>
        <div class="form-row">
          <label for="repo-picker-repo">Repositorio</label>
          <select id="repo-picker-repo">
            <option value="">‚Äî Elige repositorio ‚Äî</option>
          </select>
        </div>
        <div class="form-row" id="repo-picker-scripts-row" style="display: none;">
          <label>Script a ejecutar</label>
          <ul class="repo-scripts-list" id="repo-picker-scripts"></ul>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-primary" id="repo-picker-use">Usar este comando y definir horario</button>
          <button type="button" class="btn btn-small btn-edit" id="repo-picker-cancel">Cancelar</button>
        </div>
      </div>

      <!-- Formulario A√±adir/Editar (se muestra al hacer clic en A√±adir o Editar) -->
      <div class="job-form-panel" id="job-form-panel" style="display: none;">
        <h3 id="job-form-title"><span class="section-emoji" aria-hidden="true">üìù</span> Nueva tarea</h3>
        <form id="job-form">
          <input type="hidden" id="job-edit-index" value="-1">
          <div class="form-row">
            <label for="job-frequency">Frecuencia</label>
            <select id="job-frequency" name="frequency">
              <% FRECUENCIAS.forEach(function(f) { %>
                <option value="<%= f.value %>"><%= f.label %></option>
              <% }); %>
            </select>
          </div>
          <div class="form-row" id="row-minute-interval" style="display: none;">
            <label for="job-minute-interval">Cada cu√°ntos minutos</label>
            <input type="number" id="job-minute-interval" name="minuteInterval" min="1" max="59" value="5">
          </div>
          <div class="form-row" id="row-hour-interval" style="display: none;">
            <label for="job-hour-interval">Cada cu√°ntas horas</label>
            <input type="number" id="job-hour-interval" name="hourInterval" min="1" max="24" value="1">
          </div>
          <div class="form-row form-row-inline" id="row-daily-time" style="display: none;">
            <div class="form-row">
              <label for="job-hour">Hora (0-23)</label>
              <input type="number" id="job-hour" name="hour" min="0" max="23" value="0">
            </div>
            <div class="form-row">
              <label for="job-minute">Minuto (0-59)</label>
              <input type="number" id="job-minute" name="minute" min="0" max="59" value="0">
            </div>
          </div>
          <div class="form-row" id="row-day-of-week" style="display: none;">
            <label for="job-day-of-week">D√≠a de la semana</label>
            <select id="job-day-of-week" name="dayOfWeek">
              <% DIAS_SEMANA.forEach(function(d) { %>
                <option value="<%= d.value %>"><%= d.label %></option>
              <% }); %>
            </select>
          </div>
          <div class="form-row" id="row-day-of-month" style="display: none;">
            <label for="job-day-of-month">D√≠a del mes (1-31)</label>
            <input type="number" id="job-day-of-month" name="dayOfMonth" min="1" max="31" value="1">
          </div>
          <div class="form-row" id="row-custom-expression" style="display: none;">
            <label for="job-custom-expression">Expresi√≥n cron (5 campos: min hora d√≠a-mes mes d√≠a-semana)</label>
            <input type="text" id="job-custom-expression" name="customExpression" placeholder="0 2 * * *">
          </div>
          <div class="form-row">
            <label for="job-command">Comando a ejecutar *</label>
            <textarea id="job-command" name="command" placeholder="/ruta/al/script.sh o: cd /ruta && ./script.sh" required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Guardar tarea</button>
            <button type="button" class="btn btn-small btn-edit" id="btn-cancel-form">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <!-- PM2: procesos gestionados por PM2 (mantener en marcha, reiniciar) -->
    <section class="pm2-section card-section" id="pm2">
      <h2><span class="section-emoji" aria-hidden="true">üîÑ</span> PM2</h2>
      <p class="intro">Procesos que se mantienen en marcha con PM2 (servidores, <code>npm run start-all</code>, etc.). Aqu√≠ puedes ver el estado, arrancar, parar, reiniciar o eliminar. No sustituye al crontab: usa crontab para tareas que se ejecutan a una hora; usa PM2 para procesos que deben estar siempre activos.</p>
      <div class="form-actions" style="margin-bottom: 1rem;">
        <button type="button" class="btn btn-primary" id="pm2-btn-refresh">Actualizar lista</button>
        <button type="button" class="btn btn-primary" id="pm2-btn-add">A√±adir proceso</button>
        <span id="pm2-status" class="status"></span>
      </div>
      <ul class="pm2-list jobs-list" id="pm2-list"></ul>
      <p class="no-jobs" id="pm2-no-processes" style="display: none;">No hay procesos en PM2. Pulsa <strong>A√±adir proceso</strong> para arrancar uno (por ejemplo un <code>npm run start-all</code> de un repositorio).</p>

      <div class="job-form-panel repo-picker-panel" id="pm2-add-panel" style="display: none;">
        <h3><span class="section-emoji" aria-hidden="true">‚ûï</span> A√±adir proceso PM2</h3>
        <p class="intro">Nombre √∫nico, carpeta de trabajo (opcional) y comando. Para <code>npm run start-all</code> usa script <strong>npm</strong> y argumentos <strong>run start-all</strong>.</p>
        <form id="pm2-add-form">
          <div class="form-row">
            <label for="pm2-add-name">Nombre del proceso *</label>
            <input type="text" id="pm2-add-name" placeholder="mi-app" required>
          </div>
          <div class="form-row">
            <label for="pm2-add-cwd">Carpeta de trabajo (opcional)</label>
            <div class="path-input-row">
              <input type="text" id="pm2-add-cwd" placeholder="/ruta/al/proyecto" readonly>
              <button type="button" class="btn btn-primary" id="pm2-add-browse">Buscar carpeta</button>
            </div>
          </div>
          <div class="form-row">
            <label for="pm2-add-script">Script * (ej: npm, node)</label>
            <input type="text" id="pm2-add-script" value="npm" placeholder="npm">
          </div>
          <div class="form-row">
            <label for="pm2-add-args">Argumentos (ej: run start-all)</label>
            <input type="text" id="pm2-add-args" placeholder="run start-all">
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Arrancar con PM2</button>
            <button type="button" class="btn btn-small btn-edit" id="pm2-add-cancel">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Configuraci√≥n: carpeta de repositorios -->
    <section class="config-section card-section" id="config">
      <h2><span class="section-emoji" aria-hidden="true">üìÅ</span> Configuraci√≥n</h2>
      <p class="intro">Carpeta donde est√°n tus repositorios (proyectos con package.json). Despu√©s de guardar, ve a <a href="#tareas">Gestionar tareas</a> y usa <strong>A√±adir desde repositorio</strong> para elegir un proyecto y un script (npm start, npm run ‚Ä¶) y programar la ejecuci√≥n.</p>
      <div class="form-row">
        <label for="settings-repos-path">Carpeta de repositorios</label>
        <div class="path-input-row">
          <input type="text" id="settings-repos-path" placeholder="/home/usuario/proyectos" value="<%= typeof reposPath !== 'undefined' ? reposPath : '' %>" readonly>
          <button type="button" class="btn btn-primary" id="settings-browse-repos">Buscar carpeta</button>
        </div>
        <button type="button" class="btn btn-primary" id="settings-save-repos">Guardar</button>
        <span id="settings-repos-status" class="status"></span>
      </div>
    </section>
  </main>

  <!-- Modal: explorar y elegir carpeta -->
  <div class="browse-modal-overlay" id="browse-modal-overlay" style="display: none;" aria-hidden="true">
    <div class="browse-modal" id="browse-modal" role="dialog" aria-labelledby="browse-modal-title">
      <h3 id="browse-modal-title"><span class="section-emoji" aria-hidden="true">üìÅ</span> Seleccionar carpeta de repositorios</h3>
      <p class="browse-modal-path" id="browse-modal-path"></p>
      <div class="browse-modal-toolbar">
        <button type="button" class="btn btn-small btn-edit" id="browse-modal-up">Subir</button>
      </div>
      <ul class="browse-modal-list" id="browse-modal-list"></ul>
      <div class="browse-modal-actions">
        <button type="button" class="btn btn-primary" id="browse-modal-use">Usar esta carpeta</button>
        <button type="button" class="btn btn-small btn-edit" id="browse-modal-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var jobs = <%- JSON.stringify(typeof jobs !== 'undefined' ? jobs : []) %>;
      var FREQUENCIAS = <%- JSON.stringify(typeof FRECUENCIAS !== 'undefined' ? FRECUENCIAS : []) %>;

      function buildCronExpression(opts) {
        var f = opts.frequency;
        if (f === 'at_reboot') return '@reboot';
        if (f === 'custom' && opts.customExpression) {
          var parts = String(opts.customExpression).trim().split(/\s+/);
          if (parts.length >= 5) return parts.slice(0, 5).join(' ');
          return '';
        }
        if (f === 'every_n_minutes') {
          var n = Math.max(1, Math.min(59, parseInt(opts.minuteInterval, 10) || 5));
          return '*/' + n + ' * * * *';
        }
        if (f === 'every_hour') return '0 * * * *';
        if (f === 'every_n_hours') {
          var nh = Math.max(1, Math.min(24, parseInt(opts.hourInterval, 10) || 1));
          return '0 */' + nh + ' * * *';
        }
        var hour = Math.max(0, Math.min(23, parseInt(opts.hour, 10) || 0));
        var minute = Math.max(0, Math.min(59, parseInt(opts.minute, 10) || 0));
        var m = String(minute);
        var h = String(hour);
        if (f === 'daily') return m + ' ' + h + ' * * *';
        if (f === 'weekly') {
          var dow = opts.dayOfWeek !== undefined && opts.dayOfWeek !== '' ? String(opts.dayOfWeek) : '0';
          return m + ' ' + h + ' * * ' + dow;
        }
        if (f === 'monthly') {
          var dom = Math.max(1, Math.min(31, parseInt(opts.dayOfMonth, 10) || 1));
          return m + ' ' + h + ' ' + dom + ' * *';
        }
        return '';
      }

      function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function findJobIndex(schedule, command) {
        for (var i = 0; i < jobs.length; i++) {
          if (jobs[i].schedule === schedule && jobs[i].command === command) return i;
        }
        return -1;
      }

      function makeJobCard(job, index) {
        var nextRunStr = '';
        if (job.nextRun) {
          try {
            var d = new Date(job.nextRun);
            nextRunStr = 'Pr√≥xima: ' + d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
          } catch (e) { nextRunStr = ''; }
        }
        var html = '<div class="job-info">';
        if (nextRunStr) html += '<div class="job-next-run">' + escapeHtml(nextRunStr) + '</div>';
        html += '<div class="job-schedule-human">' + escapeHtml(job.humanSchedule || job.schedule) + '</div>';
        if (job.humanCommand) {
          html += '<div class="job-human-command">' + escapeHtml(job.humanCommand) + '</div>';
        }
        html += '<div class="job-command">' + escapeHtml(job.command) + '</div></div>' +
          '<div class="job-actions">' +
          '<button type="button" class="btn-small btn-edit" data-index="' + index + '" data-action="edit">Editar</button>' +
          '<button type="button" class="btn-small btn-delete" data-index="' + index + '" data-action="delete">Eliminar</button>' +
          '</div>';
        return html;
      }

      function renderScheduleList() {
        var list = document.getElementById('schedule-list');
        var noJobs = document.getElementById('no-jobs');
        list.innerHTML = '';
        if (jobs.length === 0) {
          noJobs.style.display = 'block';
          return;
        }
        noJobs.style.display = 'none';
        var sorted = jobs.slice().sort(function (a, b) {
          var ma = a.nextRunMs != null ? a.nextRunMs : 99999999999999;
          var mb = b.nextRunMs != null ? b.nextRunMs : 99999999999999;
          return ma - mb;
        });
        sorted.forEach(function (job) {
          var idx = findJobIndex(job.schedule, job.command);
          if (idx < 0) return;
          var li = document.createElement('li');
          li.className = 'job-card';
          li.innerHTML = makeJobCard(job, idx);
          list.appendChild(li);
        });
        list.querySelectorAll('[data-action="edit"]').forEach(function (btn) {
          btn.addEventListener('click', function () { openForm(parseInt(btn.getAttribute('data-index'), 10)); });
        });
        list.querySelectorAll('[data-action="delete"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-index'), 10);
            jobs.splice(i, 1);
            renderScheduleList();
            if (typeof renderSearchResultsFromData === 'function' && document.getElementById('search-input').value.trim()) renderSearchResultsFromData(lastSearchResults);
          });
        });
      }

      function showFrequencyRows() {
        var freq = document.getElementById('job-frequency').value;
        var isReboot = (freq === 'at_reboot');
        document.getElementById('row-minute-interval').style.display = (freq === 'every_n_minutes' && !isReboot) ? 'block' : 'none';
        document.getElementById('row-hour-interval').style.display = (freq === 'every_n_hours' && !isReboot) ? 'block' : 'none';
        document.getElementById('row-daily-time').style.display = ((freq === 'daily' || freq === 'weekly' || freq === 'monthly') && !isReboot) ? 'flex' : 'none';
        document.getElementById('row-day-of-week').style.display = freq === 'weekly' ? 'block' : 'none';
        document.getElementById('row-day-of-month').style.display = freq === 'monthly' ? 'block' : 'none';
        document.getElementById('row-custom-expression').style.display = freq === 'custom' ? 'block' : 'none';
      }

      function openForm(index) {
        var panel = document.getElementById('job-form-panel');
        document.getElementById('job-form-title').innerHTML = '<span class="section-emoji" aria-hidden="true">üìù</span> ' + (index >= 0 ? 'Editar tarea' : 'Nueva tarea');
        document.getElementById('job-edit-index').value = String(index);
        if (index >= 0 && jobs[index]) {
          var j = jobs[index];
          var opt = j.formOptions || {};
          document.getElementById('job-frequency').value = opt.frequency || 'daily';
          document.getElementById('job-minute-interval').value = opt.minuteInterval || 5;
          document.getElementById('job-hour-interval').value = opt.hourInterval !== undefined ? opt.hourInterval : 1;
          document.getElementById('job-hour').value = opt.hour !== undefined ? opt.hour : 0;
          document.getElementById('job-minute').value = opt.minute !== undefined ? opt.minute : 0;
          document.getElementById('job-day-of-week').value = opt.dayOfWeek !== undefined ? String(opt.dayOfWeek) : '0';
          document.getElementById('job-day-of-month').value = opt.dayOfMonth !== undefined ? opt.dayOfMonth : 1;
          document.getElementById('job-custom-expression').value = opt.customExpression || '';
          document.getElementById('job-command').value = j.command || '';
        } else {
          document.getElementById('job-frequency').value = 'daily';
          document.getElementById('job-minute-interval').value = 5;
          document.getElementById('job-hour-interval').value = 1;
          document.getElementById('job-hour').value = 0;
          document.getElementById('job-minute').value = 0;
          document.getElementById('job-day-of-week').value = '0';
          document.getElementById('job-day-of-month').value = 1;
          document.getElementById('job-custom-expression').value = '';
          document.getElementById('job-command').value = '';
        }
        showFrequencyRows();
        panel.style.display = 'block';
      }

      function closeForm() {
        document.getElementById('job-form-panel').style.display = 'none';
        document.getElementById('job-edit-index').value = '-1';
      }

      document.getElementById('job-frequency').addEventListener('change', showFrequencyRows);

      document.getElementById('job-form').addEventListener('submit', function (e) {
        e.preventDefault();
        var opts = {
          frequency: document.getElementById('job-frequency').value,
          minuteInterval: document.getElementById('job-minute-interval').value,
          hourInterval: document.getElementById('job-hour-interval').value,
          hour: document.getElementById('job-hour').value,
          minute: document.getElementById('job-minute').value,
          dayOfWeek: document.getElementById('job-day-of-week').value,
          dayOfMonth: document.getElementById('job-day-of-month').value,
          customExpression: document.getElementById('job-custom-expression').value
        };
        var schedule = buildCronExpression(opts);
        var command = document.getElementById('job-command').value.trim();
        if (!command) return;
        var humanLabels = {
          every_n_minutes: 'Cada ' + (opts.minuteInterval || 5) + ' min',
          every_hour: 'Cada hora',
          every_n_hours: 'Cada ' + (opts.hourInterval || 1) + ' hora' + (parseInt(opts.hourInterval, 10) === 1 ? '' : 's'),
          daily: 'Diario ' + String(opts.hour).padStart(2,'0') + ':' + String(opts.minute).padStart(2,'0'),
          weekly: 'Semanal',
          monthly: 'Mensual d√≠a ' + (opts.dayOfMonth || 1),
          at_reboot: 'Cada vez que se inicia el sistema',
          custom: schedule
        };
        var humanSchedule = humanLabels[opts.frequency] || schedule;
        var index = parseInt(document.getElementById('job-edit-index').value, 10);
        var newJob = { schedule: schedule, command: command, humanSchedule: humanSchedule, formOptions: opts };
        if (index >= 0 && index < jobs.length) {
          jobs[index] = newJob;
        } else {
          jobs.push(newJob);
        }
        renderScheduleList();
        closeForm();
      });

      document.getElementById('btn-cancel-form').addEventListener('click', closeForm);
      document.getElementById('btn-add-job').addEventListener('click', function () { openForm(-1); });

      // ‚Äî‚Äî‚Äî Modal buscar carpeta ‚Äî‚Äî‚Äî
      var browseModalTargetInputId = null;
      var browseModalCurrentPath = null;

      function browseModalOpen(targetInputId) {
        browseModalTargetInputId = targetInputId;
        var input = document.getElementById(targetInputId);
        var startPath = (input && input.value) ? input.value.trim() : '';
        browseModalLoad(startPath);
        document.getElementById('browse-modal-overlay').style.display = 'flex';
        document.getElementById('browse-modal-overlay').setAttribute('aria-hidden', 'false');
      }

      function browseModalClose() {
        document.getElementById('browse-modal-overlay').style.display = 'none';
        document.getElementById('browse-modal-overlay').setAttribute('aria-hidden', 'true');
        browseModalTargetInputId = null;
      }

      function browseModalLoad(path) {
        var q = path ? '?path=' + encodeURIComponent(path) : '';
        fetch('/api/browse' + q)
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (!data.ok) {
              document.getElementById('browse-modal-path').textContent = data.error || 'Error';
              document.getElementById('browse-modal-list').innerHTML = '';
              document.getElementById('browse-modal-up').style.display = 'none';
              return;
            }
            browseModalCurrentPath = data.currentPath;
            document.getElementById('browse-modal-path').textContent = data.currentPath;
            document.getElementById('browse-modal-up').style.display = data.parentPath ? 'inline-block' : 'none';
            document.getElementById('browse-modal-up').dataset.parentPath = data.parentPath || '';

            var list = document.getElementById('browse-modal-list');
            list.innerHTML = '';
            (data.directories || []).forEach(function (d) {
              var li = document.createElement('li');
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'browse-dir-btn';
              btn.textContent = d.name;
              btn.dataset.path = d.path;
              btn.addEventListener('click', function () { browseModalLoad(d.path); });
              li.appendChild(btn);
              list.appendChild(li);
            });
          })
          .catch(function () {
            document.getElementById('browse-modal-path').textContent = 'Error de red';
            document.getElementById('browse-modal-list').innerHTML = '';
          });
      }

      document.getElementById('browse-modal-up').addEventListener('click', function () {
        var parent = this.dataset.parentPath;
        if (parent) browseModalLoad(parent);
      });

      document.getElementById('browse-modal-use').addEventListener('click', function () {
        if (browseModalTargetInputId && browseModalCurrentPath) {
          var input = document.getElementById(browseModalTargetInputId);
          if (input) input.value = browseModalCurrentPath;
        }
        browseModalClose();
      });

      document.getElementById('browse-modal-cancel').addEventListener('click', browseModalClose);
      document.getElementById('browse-modal-overlay').addEventListener('click', function (e) {
        if (e.target === this) browseModalClose();
      });

      document.getElementById('settings-browse-repos').addEventListener('click', function () {
        browseModalOpen('settings-repos-path');
      });
      document.getElementById('repo-picker-browse').addEventListener('click', function () {
        browseModalOpen('repo-picker-path');
      });

      // ‚Äî‚Äî‚Äî Configuraci√≥n: guardar carpeta de repos ‚Äî‚Äî‚Äî
      document.getElementById('settings-save-repos').addEventListener('click', function () {
        var input = document.getElementById('settings-repos-path');
        var status = document.getElementById('settings-repos-status');
        status.textContent = 'Guardando...';
        status.className = 'status';
        fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reposPath: input.value.trim() })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              status.textContent = 'Guardado';
              status.className = 'status ok';
              document.getElementById('repo-picker-path').value = data.reposPath || '';
            } else {
              status.textContent = 'Error';
              status.className = 'status err';
            }
          })
          .catch(function () {
            status.textContent = 'Error de red';
            status.className = 'status err';
          });
      });

      // ‚Äî‚Äî‚Äî A√±adir desde repositorio ‚Äî‚Äî‚Äî
      var repoPickerRepos = [];
      var repoPickerSelected = { path: null, scriptName: null, scriptCommand: null };

      function repoPickerLoadRepos(pathFromClient) {
        var url = '/api/repos';
        if (pathFromClient) url += '?path=' + encodeURIComponent(pathFromClient);
        return fetch(url).then(function (r) { return r.json(); }).then(function (data) {
          repoPickerRepos = data.ok ? (data.repos || []) : [];
          var sel = document.getElementById('repo-picker-repo');
          sel.innerHTML = '<option value="">‚Äî Elige repositorio ‚Äî</option>';
          repoPickerRepos.forEach(function (r) {
            var opt = document.createElement('option');
            opt.value = r.path;
            opt.textContent = r.name;
            sel.appendChild(opt);
          });
          document.getElementById('repo-picker-scripts-row').style.display = 'none';
          document.getElementById('repo-picker-scripts').innerHTML = '';
          repoPickerSelected = { path: null, scriptName: null, scriptCommand: null };
          return data;
        });
      }

      document.getElementById('btn-add-from-repo').addEventListener('click', function () {
        var panel = document.getElementById('repo-picker-panel');
        panel.style.display = 'block';
        var pathInput = document.getElementById('repo-picker-path');
        pathInput.value = document.getElementById('settings-repos-path').value;
        document.getElementById('repo-picker-path-status').textContent = '';
        repoPickerLoadRepos(pathInput.value.trim()).then(function (data) {
          if (!data.ok && data.error) {
            document.getElementById('repo-picker-path-status').textContent = data.error;
            document.getElementById('repo-picker-path-status').className = 'status err';
          }
        });
      });

      document.getElementById('repo-picker-repo').addEventListener('change', function () {
        var path = this.value;
        var row = document.getElementById('repo-picker-scripts-row');
        var list = document.getElementById('repo-picker-scripts');
        list.innerHTML = '';
        repoPickerSelected = { path: null, scriptName: null, scriptCommand: null };
        if (!path) {
          row.style.display = 'none';
          return;
        }
        var repo = repoPickerRepos.find(function (r) { return r.path === path; });
        if (!repo || !repo.scripts.length) {
          row.style.display = 'none';
          return;
        }
        repo.scripts.forEach(function (s) {
          var li = document.createElement('li');
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-small btn-edit repo-script-btn';
          btn.textContent = s.name + ' (' + s.command + ')';
          btn.dataset.scriptName = s.name;
          btn.dataset.scriptCommand = s.command;
          btn.addEventListener('click', function () {
            list.querySelectorAll('.repo-script-btn').forEach(function (b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            repoPickerSelected = { path: repo.path, scriptName: s.name, scriptCommand: s.command };
          });
          li.appendChild(btn);
          list.appendChild(li);
        });
        row.style.display = 'block';
      });

      document.getElementById('repo-picker-use').addEventListener('click', function () {
        if (!repoPickerSelected.path || !repoPickerSelected.scriptCommand) {
          return;
        }
        var command = 'cd ' + repoPickerSelected.path + ' && ' + repoPickerSelected.scriptCommand;
        document.getElementById('repo-picker-panel').style.display = 'none';
        openForm(-1);
        document.getElementById('job-command').value = command;
      });

      document.getElementById('repo-picker-cancel').addEventListener('click', function () {
        document.getElementById('repo-picker-panel').style.display = 'none';
      });

      document.getElementById('repo-picker-save-path').addEventListener('click', function () {
        var input = document.getElementById('repo-picker-path');
        var status = document.getElementById('repo-picker-path-status');
        status.textContent = 'Guardando...';
        status.className = 'status';
        fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reposPath: input.value.trim() })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              status.textContent = 'Guardado. Recargando lista‚Ä¶';
              status.className = 'status ok';
              document.getElementById('settings-repos-path').value = data.reposPath || '';
              repoPickerLoadRepos((data.reposPath || '').trim());
            } else {
              status.textContent = 'Error';
              status.className = 'status err';
            }
          })
          .catch(function () {
            status.textContent = 'Error de red';
            status.className = 'status err';
          });
      });

      // ‚Äî‚Äî‚Äî PM2: listar, a√±adir, parar, reiniciar, eliminar ‚Äî‚Äî‚Äî
      var pm2List = [];

      function formatUptime(ms) {
        if (ms == null || ms < 0) return '‚Äî';
        var s = Math.floor(ms / 1000);
        var m = Math.floor(s / 60);
        var h = Math.floor(m / 60);
        s = s % 60;
        m = m % 60;
        if (h > 0) return h + 'h ' + m + 'm';
        if (m > 0) return m + 'm ' + s + 's';
        return s + 's';
      }

      function renderPM2List() {
        var listEl = document.getElementById('pm2-list');
        var noEl = document.getElementById('pm2-no-processes');
        listEl.innerHTML = '';
        if (pm2List.length === 0) {
          noEl.style.display = 'block';
          return;
        }
        noEl.style.display = 'none';
        pm2List.forEach(function (proc) {
          var li = document.createElement('li');
          li.className = 'job-card';
          var statusClass = proc.status === 'online' ? 'ok' : (proc.status === 'stopped' ? 'err' : '');
          var statusText = proc.status === 'online' ? 'En marcha' : (proc.status === 'stopped' ? 'Parado' : proc.status);
          var html = '<div class="job-info">' +
            '<div class="job-schedule-human"><strong>' + escapeHtml(proc.name) + '</strong></div>' +
            '<div class="job-human-command">Estado: <span class="status ' + statusClass + '">' + escapeHtml(statusText) + '</span>' +
            (proc.pid ? ' ¬∑ PID ' + proc.pid : '') +
            (proc.uptime != null ? ' ¬∑ Uptime ' + formatUptime(proc.uptime) : '') +
            '</div>' +
            (proc.cwd ? '<div class="job-command">' + escapeHtml(proc.cwd) + '</div>' : '') +
            '</div>' +
            '<div class="job-actions">' +
            '<button type="button" class="btn-small btn-edit pm2-stop" data-name="' + escapeHtml(proc.name) + '">Parar</button>' +
            '<button type="button" class="btn-small btn-edit pm2-restart" data-name="' + escapeHtml(proc.name) + '">Reiniciar</button>' +
            '<button type="button" class="btn-small btn-delete pm2-delete" data-name="' + escapeHtml(proc.name) + '">Eliminar</button>' +
            '</div>';
          li.innerHTML = html;
          listEl.appendChild(li);
        });
        listEl.querySelectorAll('.pm2-stop').forEach(function (btn) {
          btn.addEventListener('click', function () { pm2Action('stop', btn.getAttribute('data-name')); });
        });
        listEl.querySelectorAll('.pm2-restart').forEach(function (btn) {
          btn.addEventListener('click', function () { pm2Action('restart', btn.getAttribute('data-name')); });
        });
        listEl.querySelectorAll('.pm2-delete').forEach(function (btn) {
          btn.addEventListener('click', function () { pm2Action('delete', btn.getAttribute('data-name')); });
        });
      }

      function pm2Action(action, name) {
        var statusEl = document.getElementById('pm2-status');
        statusEl.textContent = 'Ejecutando...';
        statusEl.className = 'status';
        fetch('/api/pm2/' + action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              statusEl.textContent = 'Hecho';
              statusEl.className = 'status ok';
              loadPM2List();
            } else {
              statusEl.textContent = data.error || 'Error';
              statusEl.className = 'status err';
            }
          })
          .catch(function () {
            statusEl.textContent = 'Error de red';
            statusEl.className = 'status err';
          });
      }

      function loadPM2List() {
        var statusEl = document.getElementById('pm2-status');
        statusEl.textContent = 'Cargando...';
        statusEl.className = 'status';
        fetch('/api/pm2/list')
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              pm2List = data.list || [];
              renderPM2List();
              statusEl.textContent = '';
            } else {
              pm2List = [];
              renderPM2List();
              statusEl.textContent = data.error || 'Error al cargar PM2';
              statusEl.className = 'status err';
            }
          })
          .catch(function () {
            pm2List = [];
            renderPM2List();
            statusEl.textContent = 'Error de red (¬øPM2 instalado?)';
            statusEl.className = 'status err';
          });
      }

      document.getElementById('pm2-btn-refresh').addEventListener('click', loadPM2List);
      document.getElementById('pm2-btn-add').addEventListener('click', function () {
        document.getElementById('pm2-add-panel').style.display = 'block';
        document.getElementById('pm2-add-name').value = '';
        document.getElementById('pm2-add-cwd').value = '';
        document.getElementById('pm2-add-script').value = 'npm';
        document.getElementById('pm2-add-args').value = '';
      });
      document.getElementById('pm2-add-cancel').addEventListener('click', function () {
        document.getElementById('pm2-add-panel').style.display = 'none';
      });
      document.getElementById('pm2-add-browse').addEventListener('click', function () {
        browseModalOpen('pm2-add-cwd');
      });
      document.getElementById('pm2-add-form').addEventListener('submit', function (e) {
        e.preventDefault();
        var name = document.getElementById('pm2-add-name').value.trim();
        var cwd = document.getElementById('pm2-add-cwd').value.trim();
        var script = document.getElementById('pm2-add-script').value.trim() || 'npm';
        var args = document.getElementById('pm2-add-args').value.trim();
        if (!name) return;
        var statusEl = document.getElementById('pm2-status');
        statusEl.textContent = 'Arrancando...';
        statusEl.className = 'status';
        fetch('/api/pm2/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name, cwd: cwd || undefined, script: script, args: args || undefined })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              statusEl.textContent = 'Proceso arrancado';
              statusEl.className = 'status ok';
              document.getElementById('pm2-add-panel').style.display = 'none';
              loadPM2List();
            } else {
              statusEl.textContent = data.error || 'Error';
              statusEl.className = 'status err';
            }
          })
          .catch(function () {
            statusEl.textContent = 'Error de red';
            statusEl.className = 'status err';
          });
      });
      loadPM2List();

      document.getElementById('btn-save-crontab').addEventListener('click', function () {
        var status = document.getElementById('save-status');
        status.textContent = 'Guardando...';
        status.className = 'status';
        fetch('/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobs: jobs.map(function (j) { return { schedule: j.schedule, command: j.command }; }) })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              status.textContent = 'Crontab guardado correctamente';
              status.className = 'status ok';
              setTimeout(function () { location.reload(); }, 1200);
            } else {
              status.textContent = 'Error: ' + (data.error || 'desconocido');
              status.className = 'status err';
            }
          })
          .catch(function () {
            status.textContent = 'Error de red';
            status.className = 'status err';
          });
      });

      document.getElementById('job-form-panel').style.display = 'none';
      showFrequencyRows();

      // Buscador: resultados como tarjetas editables; al buscar solo se muestran esos resultados
      var searchInput = document.getElementById('search-input');
      var searchResults = document.getElementById('search-results');
      var searchVerTodas = document.getElementById('search-ver-todas');
      var scheduleSection = document.getElementById('schedule');
      var searchTimeout = null;
      var lastSearchResults = [];

      function renderSearchResultsFromData(results) {
        lastSearchResults = results || [];
        if (!results || results.length === 0) {
          searchResults.innerHTML = '<div class="no-results">No hay tareas que coincidan.</div>';
          searchVerTodas.style.display = 'none';
          if (scheduleSection) scheduleSection.style.display = 'block';
          return;
        }
        searchVerTodas.style.display = 'block';
        if (scheduleSection) scheduleSection.style.display = 'none';
        var html = '<p class="search-result-count">' + results.length + ' resultado' + (results.length !== 1 ? 's' : '') + '.</p><ul class="search-results-list">';
        results.forEach(function (r) {
          var idx = findJobIndex(r.schedule, r.command);
          if (idx < 0) return;
          var job = jobs[idx];
          html += '<li class="job-card">' + makeJobCard(job, idx) + '</li>';
        });
        html += '</ul>';
        searchResults.innerHTML = html;
        searchResults.querySelectorAll('[data-action="edit"]').forEach(function (btn) {
          btn.addEventListener('click', function () { openForm(parseInt(btn.getAttribute('data-index'), 10)); });
        });
        searchResults.querySelectorAll('[data-action="delete"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-index'), 10);
            jobs.splice(i, 1);
            renderScheduleList();
            renderSearchResultsFromData(lastSearchResults.filter(function (r) { return findJobIndex(r.schedule, r.command) >= 0; }));
          });
        });
      }

      function doSearch() {
        var q = searchInput.value.trim();
        if (q.length === 0) {
          searchResults.innerHTML = '';
          searchVerTodas.style.display = 'none';
          if (scheduleSection) scheduleSection.style.display = 'block';
          return;
        }
        searchResults.innerHTML = '<div class="search-hint">Buscando...</div>';
        fetch('/api/search?q=' + encodeURIComponent(q))
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) renderSearchResultsFromData(data.results);
            else searchResults.innerHTML = '<div class="no-results">Error al buscar.</div>';
          })
          .catch(function () { searchResults.innerHTML = '<div class="no-results">Error de red.</div>'; });
      }

      document.getElementById('btn-ver-todas').addEventListener('click', function () {
        searchInput.value = '';
        searchResults.innerHTML = '';
        searchVerTodas.style.display = 'none';
        if (scheduleSection) scheduleSection.style.display = 'block';
      });

      searchInput.addEventListener('input', function () {
        clearTimeout(searchTimeout);
        if (searchInput.value.trim().length === 0) {
          searchResults.innerHTML = '';
          searchVerTodas.style.display = 'none';
          if (scheduleSection) scheduleSection.style.display = 'block';
          return;
        }
        searchTimeout = setTimeout(doSearch, 280);
      });
      searchInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { e.preventDefault(); clearTimeout(searchTimeout); doSearch(); }
      });

      renderScheduleList();
    })();
  </script>
</body>
</html>

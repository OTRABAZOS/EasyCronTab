<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> ‚Äì Gestor de crontab</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header class="header">
    <h1>üïí EasyCronTab</h1>
    <nav id="main-nav">
      <a href="#inicio" class="nav-link" data-view="inicio">Inicio</a>
      <a href="#schedule" class="nav-link" data-view="schedule">Lanzamientos</a>
      <a href="#vista-dia" class="nav-link" data-view="vista-dia">Calendario</a>
      <a href="#tareas" class="nav-link" data-view="tareas">Tareas</a>
      <a href="#pm2" class="nav-link" data-view="pm2">PM2</a>
      <a href="#config" class="nav-link" data-view="config">Configuraci√≥n</a>
      <a href="#acerca" class="nav-link" data-view="acerca">Acerca de</a>
    </nav>
  </header>

  <main class="main-content">
    <div class="intro-card content-section" id="intro-card">
      <p class="intro intro-lead">üöÄ Crea y edita tareas programadas sin tocar comandos de Linux: elige frecuencia (cada X minutos, diario, semanal‚Ä¶), la hora y el comando a ejecutar. Tambi√©n puedes buscar tareas en lenguaje natural.</p>
    </div>

    <!-- Buscador: resultados clickeables (Editar/Eliminar); al buscar solo se muestran esos resultados -->
    <section class="search-section card-section content-section" id="search-section">
      <h2><span class="section-emoji" aria-hidden="true">üîç</span> Buscar tareas</h2>
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Ej: cron de ara√±as, pr√≥ximas horas, backup..." autocomplete="off">
      </div>
      <div class="search-tip" aria-label="Ayuda de b√∫squeda">
        <p>Escribe para buscar. Los resultados se pueden editar o eliminar.</p>
        <p>Los resultados aparecer√°n aqu√≠ cuando busques.</p>
      </div>
      <div class="search-results" id="search-results" aria-live="polite"></div>
      <p class="search-ver-todas" id="search-ver-todas" style="display: none; margin-top: 0.5rem;">
        <button type="button" class="btn btn-small btn-edit" id="btn-ver-todas">Ver todas las tareas</button>
      </p>
    </section>

    <!-- Schedule: todas las tareas ordenadas por pr√≥xima ejecuci√≥n -->
    <section class="schedule-section card-section content-section" id="schedule">
      <h2><span class="section-emoji" aria-hidden="true">üìÖ</span> Lanzamientos</h2>
      <p class="intro">Todas las tareas ordenadas por la pr√≥xima vez que se ejecutar√°n. Puedes editar o eliminar desde aqu√≠ o desde la b√∫squeda.</p>
      <ul class="jobs-list" id="schedule-list"></ul>
      <p class="no-jobs" id="no-jobs">No hay tareas. A√±ade una con el bot√≥n de abajo.</p>
    </section>

    <!-- Calendario: vista del d√≠a con horarios y coincidencias -->
    <section class="card-section content-section" id="vista-dia">
      <h2><span class="section-emoji" aria-hidden="true">üïê</span> Calendario</h2>
      <p class="intro">Ejecuciones programadas para un d√≠a. Las franjas con m√°s de una tarea a la vez se resaltan para que veas posibles coincidencias.</p>
      <div class="day-view-controls">
        <label for="day-view-date">Fecha:</label>
        <input type="date" id="day-view-date" aria-label="Seleccionar fecha">
      </div>
      <div id="day-view-status" class="status" aria-live="polite"></div>
      <div id="day-view-timeline" class="day-view-timeline"></div>
      <p class="no-jobs" id="day-view-no-runs" style="display: none;">No hay ejecuciones programadas para este d√≠a.</p>
    </section>

    <!-- Tareas: acciones y formulario -->
    <section class="tasks-section card-section content-section" id="tareas">
      <h2><span class="section-emoji" aria-hidden="true">‚öôÔ∏è</span> Crear tareas</h2>
      <% if (typeof crontabError !== 'undefined' && crontabError) { %>
        <p class="error-message">Error al leer crontab: <%= crontabError %></p>
      <% } %>

      <div class="form-actions" style="margin-bottom: 1rem;">
        <button type="button" class="btn btn-primary" id="btn-add-job">A√±adir tarea</button>
        <button type="button" class="btn btn-primary" id="btn-add-from-repo">A√±adir desde repositorio</button>
        <button type="button" class="btn btn-primary" id="btn-save-crontab" title="Escribir los cambios en el crontab del sistema">Guardar</button>
        <span id="save-status" class="status"></span>
      </div>

      <h3 class="tasks-list-heading" style="margin-top: 1.25rem; margin-bottom: 0.5rem;">Todas las tareas</h3>
      <ul class="jobs-list" id="tareas-list"></ul>
      <p class="no-jobs" id="no-jobs-tareas" style="display: none;">No hay tareas. A√±ade una con el bot√≥n de arriba.</p>

      <div class="how-to-repos" aria-label="C√≥mo programar tareas con tus repos">
        <p><strong>¬øC√≥mo uso la carpeta de repos para programar tareas?</strong></p>
        <ol>
          <li>Pulsa <strong>A√±adir desde repositorio</strong>.</li>
          <li>Si hace falta, elige la carpeta con <strong>Buscar carpeta</strong> y <strong>Guardar ruta</strong>.</li>
          <li>Elige un <strong>repositorio</strong> en el desplegable (proyectos con <code>package.json</code>).</li>
          <li>Elige el <strong>script</strong> a ejecutar (npm start, npm run build, etc.) y pulsa <strong>Usar este comando y definir horario</strong>.</li>
          <li>En el formulario que se abre, define <strong>frecuencia y hora</strong> y guarda la tarea.</li>
          <li>Por √∫ltimo, pulsa <strong>Guardar</strong> para escribir los cambios en el sistema.</li>
        </ol>
      </div>

      <!-- Panel: elegir repo + script para rellenar comando -->
      <div class="job-form-panel repo-picker-panel" id="repo-picker-panel" style="display: none;">
        <h3><span class="section-emoji" aria-hidden="true">üì¶</span> A√±adir desde repositorio</h3>
        <p class="intro">Elige un repositorio y un script (npm start, npm run ‚Ä¶). Se rellenar√° el comando y podr√°s definir la frecuencia.</p>
        <div class="form-row">
          <label for="repo-picker-path">Carpeta de repositorios</label>
          <div class="path-input-row">
            <input type="text" id="repo-picker-path" placeholder="/ruta/a/mis/repos" value="<%= typeof reposPath !== 'undefined' ? reposPath : '' %>" readonly>
            <button type="button" class="btn btn-primary" id="repo-picker-browse">Buscar carpeta</button>
          </div>
          <button type="button" class="btn btn-small btn-edit" id="repo-picker-save-path">Guardar ruta</button>
          <span id="repo-picker-path-status" class="status"></span>
        </div>
        <div class="form-row">
          <label for="repo-picker-repo">Repositorio</label>
          <select id="repo-picker-repo" size="14" style="min-height: 14em;">
            <option value="">‚Äî Elige repositorio ‚Äî</option>
          </select>
        </div>
        <div class="form-row" id="repo-picker-scripts-row" style="display: none;">
          <label>Script a ejecutar</label>
          <ul class="repo-scripts-list" id="repo-picker-scripts"></ul>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-primary" id="repo-picker-use">Usar este comando y definir horario</button>
          <button type="button" class="btn btn-small btn-edit" id="repo-picker-cancel">Cancelar</button>
        </div>
      </div>

      <!-- Formulario A√±adir/Editar (se muestra al hacer clic en A√±adir o Editar) -->
      <div class="job-form-panel" id="job-form-panel" style="display: none;">
        <h3 id="job-form-title"><span class="section-emoji" aria-hidden="true">üìù</span> Nueva tarea</h3>
        <form id="job-form">
          <input type="hidden" id="job-edit-index" value="-1">
          <div class="form-row">
            <label for="job-frequency">Frecuencia</label>
            <select id="job-frequency" name="frequency">
              <% FRECUENCIAS.forEach(function(f) { %>
                <option value="<%= f.value %>"><%= f.label %></option>
              <% }); %>
            </select>
          </div>
          <div class="form-row" id="row-minute-interval" style="display: none;">
            <label for="job-minute-interval">Cada cu√°ntos minutos</label>
            <input type="number" id="job-minute-interval" name="minuteInterval" min="1" max="59" value="5">
          </div>
          <div class="form-row" id="row-hour-interval" style="display: none;">
            <label for="job-hour-interval">Cada cu√°ntas horas</label>
            <input type="number" id="job-hour-interval" name="hourInterval" min="1" max="24" value="1">
          </div>
          <div class="form-row" id="row-every-n-hours-minute" style="display: none;">
            <label for="job-every-n-hours-minute">En el minuto (0-59)</label>
            <input type="number" id="job-every-n-hours-minute" name="everyNHoursMinute" min="0" max="59" value="0" placeholder="0">
          </div>
          <div class="form-row form-row-inline" id="row-daily-time" style="display: none;">
            <div class="form-row">
              <label for="job-hour">Hora (0-23)</label>
              <input type="number" id="job-hour" name="hour" min="0" max="23" value="0">
            </div>
            <div class="form-row">
              <label for="job-minute">Minuto (0-59)</label>
              <input type="number" id="job-minute" name="minute" min="0" max="59" value="0">
            </div>
          </div>
          <div class="form-row" id="row-day-of-week" style="display: none;">
            <label for="job-day-of-week">D√≠a de la semana</label>
            <select id="job-day-of-week" name="dayOfWeek">
              <% DIAS_SEMANA.forEach(function(d) { %>
                <option value="<%= d.value %>"><%= d.label %></option>
              <% }); %>
            </select>
          </div>
          <div class="form-row" id="row-day-of-month" style="display: none;">
            <label for="job-day-of-month">D√≠a del mes (1-31)</label>
            <input type="number" id="job-day-of-month" name="dayOfMonth" min="1" max="31" value="1">
          </div>
          <div class="form-row" id="row-custom-expression" style="display: none;">
            <label for="job-custom-expression">Expresi√≥n cron (5 campos: min hora d√≠a-mes mes d√≠a-semana)</label>
            <input type="text" id="job-custom-expression" name="customExpression" placeholder="0 2 * * *">
          </div>
          <div class="form-row">
            <label for="job-command">Comando a ejecutar *</label>
            <textarea id="job-command" name="command" placeholder="/ruta/al/script.sh o: cd /ruta && ./script.sh" required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Guardar tarea</button>
            <button type="button" class="btn btn-small btn-edit" id="btn-cancel-form">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <!-- PM2: procesos gestionados por PM2 (mantener en marcha, reiniciar) -->
    <section class="pm2-section card-section content-section" id="pm2">
      <h2><span class="section-emoji" aria-hidden="true">üîÑ</span> PM2</h2>
      <p class="intro">Procesos que se mantienen en marcha con PM2 (servidores, <code>npm run start-all</code>, etc.). Aqu√≠ puedes ver el estado, arrancar, parar, reiniciar o eliminar. No sustituye al crontab: usa crontab para tareas que se ejecutan a una hora; usa PM2 para procesos que deben estar siempre activos.</p>
      <div class="form-actions" style="margin-bottom: 1rem;">
        <button type="button" class="btn btn-primary" id="pm2-btn-refresh">Actualizar lista</button>
        <button type="button" class="btn btn-primary" id="pm2-btn-add">A√±adir proceso</button>
        <button type="button" class="btn btn-small btn-edit" id="pm2-btn-save" title="Guardar lista de procesos PM2 para que se restauren al reiniciar (pm2 save)">Guardar</button>
        <span id="pm2-status" class="status"></span>
      </div>
      <ul class="pm2-list jobs-list" id="pm2-list"></ul>
      <p class="no-jobs" id="pm2-no-processes" style="display: none;">No hay procesos en PM2. Pulsa <strong>A√±adir proceso</strong> para arrancar uno (por ejemplo un <code>npm run start-all</code> de un repositorio).</p>

      <div class="job-form-panel repo-picker-panel" id="pm2-add-panel" style="display: none;">
        <h3><span class="section-emoji" aria-hidden="true">‚ûï</span> A√±adir proceso PM2</h3>
        <p class="intro">Usa la misma carpeta de repositorios que en <a href="#config">Configuraci√≥n</a>. Elige un proyecto y el script a ejecutar (npm start, npm run start-all, etc.); el proceso se mantendr√° en marcha con PM2.</p>
        <div class="form-row">
          <label for="pm2-add-path">Carpeta de repositorios</label>
          <div class="path-input-row">
            <input type="text" id="pm2-add-path" placeholder="Configura la carpeta en Configuraci√≥n" value="<%= typeof reposPath !== 'undefined' ? reposPath : '' %>" readonly>
            <button type="button" class="btn btn-primary" id="pm2-add-browse">Buscar carpeta</button>
          </div>
          <button type="button" class="btn btn-small btn-edit" id="pm2-add-save-path">Guardar ruta</button>
          <span id="pm2-add-path-status" class="status"></span>
        </div>
        <div class="form-row">
          <label for="pm2-add-repo">Proyecto</label>
          <select id="pm2-add-repo" size="14" style="min-height: 14em;">
            <option value="">‚Äî Elige proyecto ‚Äî</option>
          </select>
        </div>
        <div class="form-row" id="pm2-add-scripts-row" style="display: none;">
          <label>Script a ejecutar con PM2</label>
          <ul class="repo-scripts-list" id="pm2-add-scripts"></ul>
        </div>
        <div class="form-row" id="pm2-add-name-row" style="display: none;">
          <label for="pm2-add-name">Nombre del proceso en PM2 *</label>
          <input type="text" id="pm2-add-name" placeholder="nombre-del-proceso" required>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-primary" id="pm2-add-start-btn">Arrancar con PM2</button>
          <button type="button" class="btn btn-small btn-edit" id="pm2-add-cancel">Cancelar</button>
          <span id="pm2-add-status" class="status" style="margin-left: 0.5rem;"></span>
        </div>
      </div>
    </section>

    <!-- Configuraci√≥n: carpeta de repositorios -->
    <section class="config-section card-section content-section" id="config">
      <h2><span class="section-emoji" aria-hidden="true">üìÅ</span> Configuraci√≥n</h2>
      <p class="intro">Carpeta donde est√°n tus repositorios (proyectos con package.json). Despu√©s de guardar, ve a Crear tareas y usa <strong>A√±adir desde repositorio</strong> para elegir un proyecto y un script (npm start, npm run ‚Ä¶) y programar la ejecuci√≥n.</p>
      <div class="form-row">
        <label for="settings-repos-path">Carpeta de repositorios</label>
        <div class="path-input-row">
          <input type="text" id="settings-repos-path" placeholder="/home/usuario/proyectos" value="<%= typeof reposPath !== 'undefined' ? reposPath : '' %>" readonly>
          <button type="button" class="btn btn-primary" id="settings-browse-repos">Buscar carpeta</button>
        </div>
        <button type="button" class="btn btn-primary" id="settings-save-repos">Guardar</button>
        <span id="settings-repos-status" class="status"></span>
      </div>
    </section>

    <!-- Acerca de: versi√≥n y desarrollador -->
    <section class="card-section content-section" id="acerca">
      <h2><span class="section-emoji" aria-hidden="true">‚ÑπÔ∏è</span> Acerca de</h2>
      <div class="about-content">
        <p class="about-app-name">EasyCronTab</p>
        <p class="about-version">Versi√≥n <strong><%= typeof appVersion !== 'undefined' ? appVersion : '1.0.0' %></strong></p>
        <% if (typeof appDescription !== 'undefined' && appDescription) { %>
        <p class="about-description"><%= appDescription %></p>
        <% } %>
        <p class="about-repo">
          <a href="<%= typeof appRepo !== 'undefined' ? appRepo : 'https://github.com/OTRABAZOS/EasyCronTab' %>" target="_blank" rel="noopener noreferrer">Repositorio en GitHub</a>
        </p>
      </div>
    </section>
  </main>

  <!-- Modal: explorar y elegir carpeta -->
  <div class="browse-modal-overlay" id="browse-modal-overlay" style="display: none;" aria-hidden="true">
    <div class="browse-modal" id="browse-modal" role="dialog" aria-labelledby="browse-modal-title">
      <h3 id="browse-modal-title"><span class="section-emoji" aria-hidden="true">üìÅ</span> Seleccionar carpeta de repositorios</h3>
      <p class="browse-modal-path" id="browse-modal-path"></p>
      <div class="browse-modal-toolbar">
        <button type="button" class="btn btn-small btn-edit" id="browse-modal-up">Subir</button>
      </div>
      <ul class="browse-modal-list" id="browse-modal-list"></ul>
      <div class="browse-modal-actions">
        <button type="button" class="btn btn-primary" id="browse-modal-use">Usar esta carpeta</button>
        <button type="button" class="btn btn-small btn-edit" id="browse-modal-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal: ver log de ejecuci√≥n -->
  <div class="log-modal-overlay" id="log-modal-overlay" style="display: none;" aria-hidden="true">
    <div class="log-modal" id="log-modal" role="dialog" aria-labelledby="log-modal-title">
      <h3 id="log-modal-title"><span class="section-emoji" aria-hidden="true">üìÑ</span> Log de ejecuci√≥n</h3>
      <p id="log-modal-mtime" class="log-modal-mtime" aria-live="polite"></p>
      <pre id="log-modal-content" class="log-modal-content"></pre>
      <div class="log-modal-actions">
        <button type="button" class="btn btn-small btn-edit" id="log-modal-close">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var jobs = <%- JSON.stringify(typeof jobs !== 'undefined' ? jobs : []) %>;
      var FREQUENCIAS = <%- JSON.stringify(typeof FRECUENCIAS !== 'undefined' ? FRECUENCIAS : []) %>;

      // Navegaci√≥n por vistas: al hacer clic en el men√∫ se muestra solo esa secci√≥n (sin anclas de una sola p√°gina)
      var VIEW_SECTIONS = {
        'inicio': ['intro-card', 'search-section', 'vista-dia'],
        'schedule': ['schedule'],
        'vista-dia': ['vista-dia'],
        'tareas': ['tareas'],
        'pm2': ['pm2'],
        'config': ['config'],
        'acerca': ['acerca']
      };
      function switchView(viewName) {
        var ids = VIEW_SECTIONS[viewName];
        if (!ids) viewName = 'inicio'; ids = VIEW_SECTIONS[viewName];
        document.querySelectorAll('.content-section').forEach(function (el) {
          el.style.display = ids.indexOf(el.id) >= 0 ? 'block' : 'none';
        });
        document.querySelectorAll('#main-nav .nav-link').forEach(function (a) {
          a.classList.toggle('nav-active', a.getAttribute('data-view') === viewName);
        });
        if (location.hash !== '#' + viewName) location.hash = viewName;
      }
      document.getElementById('main-nav').addEventListener('click', function (e) {
        var a = e.target.closest('a[data-view]');
        if (a) { e.preventDefault(); switchView(a.getAttribute('data-view')); }
      });
      window.addEventListener('hashchange', function () {
        var view = (location.hash || '#inicio').slice(1);
        if (VIEW_SECTIONS[view]) switchView(view);
      });
      var initialView = (location.hash && VIEW_SECTIONS[location.hash.slice(1)]) ? location.hash.slice(1) : 'inicio';
      switchView(initialView);

      function buildCronExpression(opts) {
        var f = opts.frequency;
        if (f === 'at_reboot') return '@reboot';
        if (f === 'custom' && opts.customExpression) {
          var parts = String(opts.customExpression).trim().split(/\s+/);
          if (parts.length >= 5) return parts.slice(0, 5).join(' ');
          return '';
        }
        if (f === 'every_n_minutes') {
          var n = Math.max(1, Math.min(59, parseInt(opts.minuteInterval, 10) || 5));
          return '*/' + n + ' * * * *';
        }
        if (f === 'every_hour') return '0 * * * *';
        if (f === 'every_n_hours') {
          var nh = Math.max(1, Math.min(24, parseInt(opts.hourInterval, 10) || 1));
          var everyNMin = Math.max(0, Math.min(59, parseInt(opts.everyNHoursMinute ?? opts.minute, 10) || 0));
          return everyNMin + ' */' + nh + ' * * *';
        }
        var hour = Math.max(0, Math.min(23, parseInt(opts.hour, 10) || 0));
        var minute = Math.max(0, Math.min(59, parseInt(opts.minute, 10) || 0));
        var m = String(minute);
        var h = String(hour);
        if (f === 'daily') return m + ' ' + h + ' * * *';
        if (f === 'weekly') {
          var dow = opts.dayOfWeek !== undefined && opts.dayOfWeek !== '' ? String(opts.dayOfWeek) : '0';
          return m + ' ' + h + ' * * ' + dow;
        }
        if (f === 'monthly') {
          var dom = Math.max(1, Math.min(31, parseInt(opts.dayOfMonth, 10) || 1));
          return m + ' ' + h + ' ' + dom + ' * *';
        }
        return '';
      }

      function escapeHtml(s) {
        if (!s) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function formatLogMtime(ms) {
        if (!ms) return '';
        var d = new Date(ms);
        var now = Date.now();
        var diff = now - ms;
        if (diff < 60000) return '√öltima escritura: hace un momento (posiblemente en ejecuci√≥n)';
        if (diff < 3600000) return '√öltima escritura: hace ' + Math.floor(diff / 60000) + ' min';
        if (diff < 86400000) return '√öltima escritura: hace ' + Math.floor(diff / 3600000) + ' h';
        var day = ('0' + d.getDate()).slice(-2);
        var month = ('0' + (d.getMonth() + 1)).slice(-2);
        var hour = ('0' + d.getHours()).slice(-2);
        var min = ('0' + d.getMinutes()).slice(-2);
        return '√öltima escritura: ' + day + '/' + month + '/' + d.getFullYear() + ', ' + hour + ':' + min;
      }

      function setLogModalMtime(data) {
        var mtimeEl = document.getElementById('log-modal-mtime');
        if (!mtimeEl) return;
        if (data && data.ok && data.logUpdatedAt != null) {
          mtimeEl.style.display = 'block';
          mtimeEl.textContent = formatLogMtime(data.logUpdatedAt);
        } else {
          mtimeEl.style.display = 'none';
          mtimeEl.textContent = '';
        }
      }

      function findJobIndex(schedule, command) {
        for (var i = 0; i < jobs.length; i++) {
          if (jobs[i].schedule === schedule && jobs[i].command === command) return i;
        }
        return -1;
      }

      function makeJobCard(job, index) {
        var nextRunStr = '';
        if (job.nextRun) {
          try {
            var d = new Date(job.nextRun);
            nextRunStr = 'Pr√≥xima: ' + d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' + d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
          } catch (e) { nextRunStr = ''; }
        }
        var html = '<div class="job-info">';
        if (nextRunStr) html += '<div class="job-next-run">' + escapeHtml(nextRunStr) + '</div>';
        html += '<div class="job-schedule-human">' + escapeHtml(job.humanSchedule || job.schedule) + '</div>';
        if (job.humanCommand) {
          html += '<div class="job-human-command">' + escapeHtml(job.humanCommand) + '</div>';
        }
        html += '<div class="job-command">' + escapeHtml(job.command) + '</div>';
        var logStatus = job.logStatus || 'unknown';
        var logLabel = logStatus === 'ok' ? 'OK' : (logStatus === 'failed' ? 'Error' : 'Sin log');
        html += '<div class="job-log-row"><span class="job-log-status job-log-status--' + logStatus + '" title="Estado de la √∫ltima ejecuci√≥n">' + escapeHtml(logLabel) + '</span> <button type="button" class="btn-small btn-edit job-log-view" data-index="' + index + '" title="Ver log de ejecuci√≥n">Log</button> <button type="button" class="btn-small btn-primary job-run-now" data-index="' + index + '" title="Ejecutar esta tarea ahora (la salida se guardar√° en el log)">Ejecuta</button></div></div>' +
          '<div class="job-actions">' +
          '<button type="button" class="btn-small btn-edit" data-index="' + index + '" data-action="edit">Edita</button>' +
          '<button type="button" class="btn-small btn-delete" data-index="' + index + '" data-action="delete">Elimina</button>' +
          '</div>';
        return html;
      }

      function renderScheduleList() {
        var list = document.getElementById('schedule-list');
        var listTareas = document.getElementById('tareas-list');
        var noJobs = document.getElementById('no-jobs');
        var noJobsTareas = document.getElementById('no-jobs-tareas');
        list.innerHTML = '';
        if (listTareas) listTareas.innerHTML = '';
        if (jobs.length === 0) {
          if (noJobs) noJobs.style.display = 'block';
          if (noJobsTareas) noJobsTareas.style.display = 'block';
          return;
        }
        if (noJobs) noJobs.style.display = 'none';
        if (noJobsTareas) noJobsTareas.style.display = 'none';
        var sorted = jobs.slice().sort(function (a, b) {
          var ma = a.nextRunMs != null ? a.nextRunMs : 99999999999999;
          var mb = b.nextRunMs != null ? b.nextRunMs : 99999999999999;
          return ma - mb;
        });
        function appendCardTo(container) {
          sorted.forEach(function (job) {
            var idx = findJobIndex(job.schedule, job.command);
            if (idx < 0) return;
            var li = document.createElement('li');
            li.className = 'job-card';
            li.innerHTML = makeJobCard(job, idx);
            container.appendChild(li);
          });
        }
        appendCardTo(list);
        if (listTareas) appendCardTo(listTareas);
        function bindListeners(container) {
          if (!container) return;
          container.querySelectorAll('[data-action="edit"]').forEach(function (btn) {
            btn.addEventListener('click', function () { openForm(parseInt(btn.getAttribute('data-index'), 10)); });
          });
          container.querySelectorAll('[data-action="delete"]').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var i = parseInt(btn.getAttribute('data-index'), 10);
              jobs.splice(i, 1);
              renderScheduleList();
              if (typeof renderSearchResultsFromData === 'function' && document.getElementById('search-input').value.trim()) renderSearchResultsFromData(lastSearchResults);
            });
          });
          container.querySelectorAll('.job-log-view').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var i = parseInt(btn.getAttribute('data-index'), 10);
              if (i < 0 || !jobs[i]) return;
              var job = jobs[i];
              document.getElementById('log-modal-title').textContent = '\uD83D\uDCC4 Log de ejecuci√≥n';
              document.getElementById('log-modal-content').textContent = 'Cargando...';
              setLogModalMtime(null);
              document.getElementById('log-modal-overlay').style.display = 'block';
              document.getElementById('log-modal-overlay').setAttribute('aria-hidden', 'false');
              fetch('/api/jobs/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schedule: job.schedule, command: job.command })
              }).then(function (r) { return r.json(); }).then(function (data) {
                document.getElementById('log-modal-content').textContent = data.ok ? data.content : (data.error || 'Error al cargar');
                setLogModalMtime(data);
              }).catch(function (err) {
                document.getElementById('log-modal-content').textContent = 'Error de red: ' + (err.message || 'desconocido');
                setLogModalMtime(null);
              });
            });
          });
          container.querySelectorAll('.job-run-now').forEach(function (btn) {
            btn.addEventListener('click', function () {
              var i = parseInt(btn.getAttribute('data-index'), 10);
              if (i < 0 || !jobs[i]) return;
              var job = jobs[i];
              btn.disabled = true;
              btn.textContent = 'Lanzando...';
              fetch('/api/jobs/run-now', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ schedule: job.schedule, command: job.command })
              }).then(function (r) { return r.json(); }).then(function (data) {
                btn.disabled = false;
                btn.textContent = 'Ejecuta';
                alert(data.ok ? (data.message || 'Ejecuci√≥n lanzada. Abre "Log" en unos segundos.') : (data.error || 'Error'));
              }).catch(function (err) {
                btn.disabled = false;
                btn.textContent = 'Ejecuta';
                alert('Error de red: ' + (err.message || 'desconocido'));
              });
            });
          });
        }
        bindListeners(list);
        bindListeners(listTareas);
      }

      function showFrequencyRows() {
        var freq = document.getElementById('job-frequency').value;
        var isReboot = (freq === 'at_reboot');
        document.getElementById('row-minute-interval').style.display = (freq === 'every_n_minutes' && !isReboot) ? 'block' : 'none';
        document.getElementById('row-hour-interval').style.display = (freq === 'every_n_hours' && !isReboot) ? 'block' : 'none';
        document.getElementById('row-every-n-hours-minute').style.display = (freq === 'every_n_hours' && !isReboot) ? 'block' : 'none';
        document.getElementById('row-daily-time').style.display = ((freq === 'daily' || freq === 'weekly' || freq === 'monthly') && !isReboot) ? 'flex' : 'none';
        document.getElementById('row-day-of-week').style.display = freq === 'weekly' ? 'block' : 'none';
        document.getElementById('row-day-of-month').style.display = freq === 'monthly' ? 'block' : 'none';
        document.getElementById('row-custom-expression').style.display = freq === 'custom' ? 'block' : 'none';
      }

      function openForm(index) {
        switchView('tareas');
        var panel = document.getElementById('job-form-panel');
        document.getElementById('job-form-title').innerHTML = '<span class="section-emoji" aria-hidden="true">üìù</span> ' + (index >= 0 ? 'Editar tarea' : 'Nueva tarea');
        document.getElementById('job-edit-index').value = String(index);
        if (index >= 0 && jobs[index]) {
          var j = jobs[index];
          var opt = j.formOptions || {};
          document.getElementById('job-frequency').value = opt.frequency || 'daily';
          document.getElementById('job-minute-interval').value = opt.minuteInterval || 5;
          document.getElementById('job-hour-interval').value = opt.hourInterval !== undefined ? opt.hourInterval : 1;
          document.getElementById('job-every-n-hours-minute').value = (opt.minute !== undefined ? opt.minute : 0);
          document.getElementById('job-hour').value = opt.hour !== undefined ? opt.hour : 0;
          document.getElementById('job-minute').value = opt.minute !== undefined ? opt.minute : 0;
          document.getElementById('job-day-of-week').value = opt.dayOfWeek !== undefined ? String(opt.dayOfWeek) : '0';
          document.getElementById('job-day-of-month').value = opt.dayOfMonth !== undefined ? opt.dayOfMonth : 1;
          document.getElementById('job-custom-expression').value = opt.customExpression || '';
          document.getElementById('job-command').value = j.command || '';
        } else {
          document.getElementById('job-frequency').value = 'daily';
          document.getElementById('job-minute-interval').value = 5;
          document.getElementById('job-hour-interval').value = 1;
          document.getElementById('job-every-n-hours-minute').value = 0;
          document.getElementById('job-hour').value = 0;
          document.getElementById('job-minute').value = 0;
          document.getElementById('job-day-of-week').value = '0';
          document.getElementById('job-day-of-month').value = 1;
          document.getElementById('job-custom-expression').value = '';
          document.getElementById('job-command').value = '';
        }
        showFrequencyRows();
        panel.style.display = 'block';
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function closeForm() {
        document.getElementById('job-form-panel').style.display = 'none';
        document.getElementById('job-edit-index').value = '-1';
      }

      document.getElementById('job-frequency').addEventListener('change', showFrequencyRows);

      document.getElementById('job-form').addEventListener('submit', function (e) {
        e.preventDefault();
        var opts = {
          frequency: document.getElementById('job-frequency').value,
          minuteInterval: document.getElementById('job-minute-interval').value,
          hourInterval: document.getElementById('job-hour-interval').value,
          everyNHoursMinute: document.getElementById('job-every-n-hours-minute').value,
          hour: document.getElementById('job-hour').value,
          minute: document.getElementById('job-minute').value,
          dayOfWeek: document.getElementById('job-day-of-week').value,
          dayOfMonth: document.getElementById('job-day-of-month').value,
          customExpression: document.getElementById('job-custom-expression').value
        };
        var schedule = buildCronExpression(opts);
        var command = document.getElementById('job-command').value.trim();
        if (!command) return;
        var everyNMin = parseInt(opts.everyNHoursMinute ?? opts.minute, 10) || 0;
        var humanLabels = {
          every_n_minutes: 'Cada ' + (opts.minuteInterval || 5) + ' min',
          every_hour: 'Cada hora',
          every_n_hours: 'Cada ' + (opts.hourInterval || 1) + ' hora' + (parseInt(opts.hourInterval, 10) === 1 ? '' : 's') + (everyNMin > 0 ? ' al min ' + everyNMin : ''),
          daily: 'Diario ' + String(opts.hour).padStart(2,'0') + ':' + String(opts.minute).padStart(2,'0'),
          weekly: 'Semanal',
          monthly: 'Mensual d√≠a ' + (opts.dayOfMonth || 1),
          at_reboot: 'Cada vez que se inicia el sistema',
          custom: schedule
        };
        var humanSchedule = humanLabels[opts.frequency] || schedule;
        var index = parseInt(document.getElementById('job-edit-index').value, 10);
        var newJob = { schedule: schedule, command: command, humanSchedule: humanSchedule, formOptions: opts };
        if (index >= 0 && index < jobs.length) {
          jobs[index] = newJob;
        } else {
          jobs.push(newJob);
        }
        renderScheduleList();
        closeForm();
      });

      document.getElementById('btn-cancel-form').addEventListener('click', closeForm);
      document.getElementById('btn-add-job').addEventListener('click', function () { openForm(-1); });

      document.getElementById('log-modal-close').addEventListener('click', function () {
        document.getElementById('log-modal-overlay').style.display = 'none';
        document.getElementById('log-modal-overlay').setAttribute('aria-hidden', 'true');
      });
      document.getElementById('log-modal-overlay').addEventListener('click', function (e) {
        if (e.target === document.getElementById('log-modal-overlay')) {
          document.getElementById('log-modal-overlay').style.display = 'none';
          document.getElementById('log-modal-overlay').setAttribute('aria-hidden', 'true');
        }
      });

      // ‚Äî‚Äî‚Äî Modal buscar carpeta ‚Äî‚Äî‚Äî
      var browseModalTargetInputId = null;
      var browseModalCurrentPath = null;

      function browseModalOpen(targetInputId) {
        browseModalTargetInputId = targetInputId;
        var input = document.getElementById(targetInputId);
        var startPath = (input && input.value) ? input.value.trim() : '';
        browseModalLoad(startPath);
        document.getElementById('browse-modal-overlay').style.display = 'flex';
        document.getElementById('browse-modal-overlay').setAttribute('aria-hidden', 'false');
      }

      function browseModalClose() {
        document.getElementById('browse-modal-overlay').style.display = 'none';
        document.getElementById('browse-modal-overlay').setAttribute('aria-hidden', 'true');
        browseModalTargetInputId = null;
      }

      function browseModalLoad(path) {
        var q = path ? '?path=' + encodeURIComponent(path) : '';
        fetch('/api/browse' + q)
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (!data.ok) {
              document.getElementById('browse-modal-path').textContent = data.error || 'Error';
              document.getElementById('browse-modal-list').innerHTML = '';
              document.getElementById('browse-modal-up').style.display = 'none';
              return;
            }
            browseModalCurrentPath = data.currentPath;
            document.getElementById('browse-modal-path').textContent = data.currentPath;
            document.getElementById('browse-modal-up').style.display = data.parentPath ? 'inline-block' : 'none';
            document.getElementById('browse-modal-up').dataset.parentPath = data.parentPath || '';

            var list = document.getElementById('browse-modal-list');
            list.innerHTML = '';
            (data.directories || []).forEach(function (d) {
              var li = document.createElement('li');
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'browse-dir-btn';
              btn.textContent = d.name;
              btn.dataset.path = d.path;
              btn.addEventListener('click', function () { browseModalLoad(d.path); });
              li.appendChild(btn);
              list.appendChild(li);
            });
          })
          .catch(function () {
            document.getElementById('browse-modal-path').textContent = 'Error de red';
            document.getElementById('browse-modal-list').innerHTML = '';
          });
      }

      document.getElementById('browse-modal-up').addEventListener('click', function () {
        var parent = this.dataset.parentPath;
        if (parent) browseModalLoad(parent);
      });

      document.getElementById('browse-modal-use').addEventListener('click', function () {
        if (browseModalTargetInputId && browseModalCurrentPath) {
          var input = document.getElementById(browseModalTargetInputId);
          if (input) input.value = browseModalCurrentPath;
        }
        browseModalClose();
      });

      document.getElementById('browse-modal-cancel').addEventListener('click', browseModalClose);
      document.getElementById('browse-modal-overlay').addEventListener('click', function (e) {
        if (e.target === this) browseModalClose();
      });

      document.getElementById('settings-browse-repos').addEventListener('click', function () {
        browseModalOpen('settings-repos-path');
      });
      document.getElementById('repo-picker-browse').addEventListener('click', function () {
        browseModalOpen('repo-picker-path');
      });

      // ‚Äî‚Äî‚Äî Configuraci√≥n: guardar carpeta de repos ‚Äî‚Äî‚Äî
      document.getElementById('settings-save-repos').addEventListener('click', function () {
        var input = document.getElementById('settings-repos-path');
        var status = document.getElementById('settings-repos-status');
        status.textContent = 'Guardando...';
        status.className = 'status';
        fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reposPath: input.value.trim() })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              status.textContent = 'Guardado';
              status.className = 'status ok';
              document.getElementById('repo-picker-path').value = data.reposPath || '';
            } else {
              status.textContent = 'Error';
              status.className = 'status err';
            }
          })
          .catch(function () {
            status.textContent = 'Error de red';
            status.className = 'status err';
          });
      });

      // ‚Äî‚Äî‚Äî A√±adir desde repositorio ‚Äî‚Äî‚Äî
      var repoPickerRepos = [];
      var repoPickerSelected = { path: null, scriptName: null, scriptCommand: null };

      function repoPickerLoadRepos(pathFromClient) {
        var url = '/api/repos';
        if (pathFromClient) url += '?path=' + encodeURIComponent(pathFromClient);
        return fetch(url).then(function (r) { return r.json(); }).then(function (data) {
          repoPickerRepos = data.ok ? (data.repos || []) : [];
          var sel = document.getElementById('repo-picker-repo');
          sel.innerHTML = '<option value="">‚Äî Elige repositorio ‚Äî</option>';
          repoPickerRepos.forEach(function (r) {
            var opt = document.createElement('option');
            opt.value = r.path;
            opt.textContent = r.name;
            sel.appendChild(opt);
          });
          document.getElementById('repo-picker-scripts-row').style.display = 'none';
          document.getElementById('repo-picker-scripts').innerHTML = '';
          repoPickerSelected = { path: null, scriptName: null, scriptCommand: null };
          return data;
        });
      }

      document.getElementById('btn-add-from-repo').addEventListener('click', function () {
        var panel = document.getElementById('repo-picker-panel');
        panel.style.display = 'block';
        var pathInput = document.getElementById('repo-picker-path');
        pathInput.value = document.getElementById('settings-repos-path').value;
        document.getElementById('repo-picker-path-status').textContent = '';
        repoPickerLoadRepos(pathInput.value.trim()).then(function (data) {
          if (!data.ok && data.error) {
            document.getElementById('repo-picker-path-status').textContent = data.error;
            document.getElementById('repo-picker-path-status').className = 'status err';
          }
        });
      });

      document.getElementById('repo-picker-repo').addEventListener('change', function () {
        var path = this.value;
        var row = document.getElementById('repo-picker-scripts-row');
        var list = document.getElementById('repo-picker-scripts');
        list.innerHTML = '';
        repoPickerSelected = { path: null, scriptName: null, scriptCommand: null };
        if (!path) {
          row.style.display = 'none';
          return;
        }
        var repo = repoPickerRepos.find(function (r) { return r.path === path; });
        if (!repo || !repo.scripts.length) {
          row.style.display = 'none';
          return;
        }
        repo.scripts.forEach(function (s) {
          var li = document.createElement('li');
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-small btn-edit repo-script-btn';
          btn.textContent = s.name + ' (' + s.command + ')';
          btn.dataset.scriptName = s.name;
          btn.dataset.scriptCommand = s.command;
          btn.addEventListener('click', function () {
            list.querySelectorAll('.repo-script-btn').forEach(function (b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            repoPickerSelected = { path: repo.path, scriptName: s.name, scriptCommand: s.command };
          });
          li.appendChild(btn);
          list.appendChild(li);
        });
        row.style.display = 'block';
      });

      document.getElementById('repo-picker-use').addEventListener('click', function () {
        if (!repoPickerSelected.path || !repoPickerSelected.scriptCommand) {
          return;
        }
        var command = 'cd ' + repoPickerSelected.path + ' && ' + repoPickerSelected.scriptCommand;
        document.getElementById('repo-picker-panel').style.display = 'none';
        openForm(-1);
        document.getElementById('job-command').value = command;
      });

      document.getElementById('repo-picker-cancel').addEventListener('click', function () {
        document.getElementById('repo-picker-panel').style.display = 'none';
      });

      document.getElementById('repo-picker-save-path').addEventListener('click', function () {
        var input = document.getElementById('repo-picker-path');
        var status = document.getElementById('repo-picker-path-status');
        status.textContent = 'Guardando...';
        status.className = 'status';
        fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reposPath: input.value.trim() })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              status.textContent = 'Guardado. Recargando lista‚Ä¶';
              status.className = 'status ok';
              document.getElementById('settings-repos-path').value = data.reposPath || '';
              repoPickerLoadRepos((data.reposPath || '').trim());
            } else {
              status.textContent = 'Error';
              status.className = 'status err';
            }
          })
          .catch(function () {
            status.textContent = 'Error de red';
            status.className = 'status err';
          });
      });

      // ‚Äî‚Äî‚Äî PM2: listar, a√±adir, parar, reiniciar, eliminar ‚Äî‚Äî‚Äî
      var pm2List = [];

      function formatUptime(ms) {
        if (ms == null || ms < 0) return '‚Äî';
        var s = Math.floor(ms / 1000);
        var m = Math.floor(s / 60);
        var h = Math.floor(m / 60);
        s = s % 60;
        m = m % 60;
        if (h > 0) return h + 'h ' + m + 'm';
        if (m > 0) return m + 'm ' + s + 's';
        return s + 's';
      }

      function renderPM2List() {
        var listEl = document.getElementById('pm2-list');
        var noEl = document.getElementById('pm2-no-processes');
        listEl.innerHTML = '';
        if (pm2List.length === 0) {
          noEl.style.display = 'block';
          return;
        }
        noEl.style.display = 'none';
        pm2List.forEach(function (proc) {
          var li = document.createElement('li');
          li.className = 'job-card';
          var statusKey = proc.status === 'online' ? 'online' : (proc.status === 'stopped' ? 'stopped' : (proc.status === 'errored' ? 'errored' : 'other'));
          var statusLabel = proc.status === 'online' ? 'En marcha' : (proc.status === 'stopped' ? 'Parado' : (proc.status === 'errored' ? 'Error' : (proc.status === 'launching' || proc.status === 'stopping' ? 'Iniciando‚Ä¶' : (proc.status || '‚Äî'))));
          var html = '<div class="job-info">' +
            '<div class="job-schedule-human"><strong>' + escapeHtml(proc.name) + '</strong></div>' +
            '<div class="job-human-command">' +
            '<span class="pm2-process-status pm2-process-status--' + statusKey + '" title="Estado del proceso">' + escapeHtml(statusLabel) + '</span>' +
            (proc.pid ? ' ¬∑ PID ' + proc.pid : '') +
            (proc.uptime != null ? ' ¬∑ Uptime ' + formatUptime(proc.uptime) : '') +
            '</div>' +
            (proc.cwd ? '<div class="job-command">' + escapeHtml(proc.cwd) + '</div>' : '') +
            '</div>' +
            '<div class="job-actions">' +
            '<button type="button" class="btn-small btn-edit pm2-log-view" data-name="' + escapeHtml(proc.name) + '" title="Ver log de PM2">Log</button>' +
            '<button type="button" class="btn-small btn-edit pm2-stop" data-name="' + escapeHtml(proc.name) + '">Parar</button>' +
            '<button type="button" class="btn-small btn-edit pm2-restart" data-name="' + escapeHtml(proc.name) + '">Reiniciar</button>' +
            '<button type="button" class="btn-small btn-delete pm2-delete" data-name="' + escapeHtml(proc.name) + '">Elimina</button>' +
            '</div>';
          li.innerHTML = html;
          listEl.appendChild(li);
        });
        listEl.querySelectorAll('.pm2-log-view').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var name = btn.getAttribute('data-name');
            if (!name) return;
            document.getElementById('log-modal-title').textContent = '\uD83D\uDCC4 Log PM2: ' + name;
            document.getElementById('log-modal-content').textContent = 'Cargando...';
            setLogModalMtime(null);
            document.getElementById('log-modal-overlay').style.display = 'block';
            document.getElementById('log-modal-overlay').setAttribute('aria-hidden', 'false');
            fetch('/api/pm2/log', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: name })
            }).then(function (r) { return r.json(); }).then(function (data) {
              document.getElementById('log-modal-content').textContent = data.ok ? data.content : (data.error || 'Error al cargar');
            }).catch(function (err) {
              document.getElementById('log-modal-content').textContent = 'Error de red: ' + (err.message || 'desconocido');
            });
          });
        });
        listEl.querySelectorAll('.pm2-stop').forEach(function (btn) {
          btn.addEventListener('click', function () { pm2Action('stop', btn.getAttribute('data-name')); });
        });
        listEl.querySelectorAll('.pm2-restart').forEach(function (btn) {
          btn.addEventListener('click', function () { pm2Action('restart', btn.getAttribute('data-name')); });
        });
        listEl.querySelectorAll('.pm2-delete').forEach(function (btn) {
          btn.addEventListener('click', function () { pm2Action('delete', btn.getAttribute('data-name')); });
        });
      }

      function pm2Action(action, name) {
        var statusEl = document.getElementById('pm2-status');
        statusEl.textContent = 'Ejecutando...';
        statusEl.className = 'status';
        fetch('/api/pm2/' + action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              statusEl.textContent = 'Hecho';
              statusEl.className = 'status ok';
              loadPM2List();
            } else {
              statusEl.textContent = data.error || 'Error';
              statusEl.className = 'status err';
            }
          })
          .catch(function () {
            statusEl.textContent = 'Error de red';
            statusEl.className = 'status err';
          });
      }

      function loadPM2List() {
        var statusEl = document.getElementById('pm2-status');
        statusEl.textContent = 'Cargando...';
        statusEl.className = 'status';
        fetch('/api/pm2/list')
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              pm2List = data.list || [];
              renderPM2List();
              statusEl.textContent = '';
            } else {
              pm2List = [];
              renderPM2List();
              statusEl.textContent = data.error || 'Error al cargar PM2';
              statusEl.className = 'status err';
            }
          })
          .catch(function () {
            pm2List = [];
            renderPM2List();
            statusEl.textContent = 'Error de red (¬øPM2 instalado?)';
            statusEl.className = 'status err';
          });
      }

      document.getElementById('pm2-btn-refresh').addEventListener('click', loadPM2List);
      document.getElementById('pm2-btn-save').addEventListener('click', function () {
        var statusEl = document.getElementById('pm2-status');
        statusEl.textContent = 'Guardando...';
        statusEl.className = 'status';
        fetch('/api/pm2/save', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              statusEl.textContent = 'Lista guardada (se restaurar√° al reiniciar si configuraste pm2 startup)';
              statusEl.className = 'status ok';
            } else {
              statusEl.textContent = data.error || 'Error';
              statusEl.className = 'status err';
            }
          })
          .catch(function () {
            statusEl.textContent = 'Error de red';
            statusEl.className = 'status err';
          });
      });
      // PM2: lista de repos (misma que en A√±adir desde repositorio)
      var pm2Repos = [];
      var pm2Selected = { path: null, name: null, scriptName: null, scriptCommand: null };

      function pm2AddLoadRepos(pathFromClient) {
        var url = '/api/repos';
        if (pathFromClient) url += '?path=' + encodeURIComponent(pathFromClient);
        return fetch(url).then(function (r) { return r.json(); }).then(function (data) {
          pm2Repos = data.ok ? (data.repos || []) : [];
          var sel = document.getElementById('pm2-add-repo');
          sel.innerHTML = '<option value="">‚Äî Elige proyecto ‚Äî</option>';
          pm2Repos.forEach(function (r) {
            var opt = document.createElement('option');
            opt.value = r.path;
            opt.textContent = r.name;
            sel.appendChild(opt);
          });
          document.getElementById('pm2-add-scripts-row').style.display = 'none';
          document.getElementById('pm2-add-scripts').innerHTML = '';
          document.getElementById('pm2-add-name-row').style.display = 'none';
          pm2Selected = { path: null, name: null, scriptName: null, scriptCommand: null };
          return data;
        });
      }

      document.getElementById('pm2-btn-add').addEventListener('click', function () {
        document.getElementById('pm2-add-panel').style.display = 'block';
        document.getElementById('pm2-add-path').value = document.getElementById('settings-repos-path').value;
        document.getElementById('pm2-add-path-status').textContent = '';
        pm2AddLoadRepos(document.getElementById('pm2-add-path').value.trim()).then(function (data) {
          if (!data.ok && data.error) {
            document.getElementById('pm2-add-path-status').textContent = data.error;
            document.getElementById('pm2-add-path-status').className = 'status err';
          }
        });
      });
      document.getElementById('pm2-add-cancel').addEventListener('click', function () {
        document.getElementById('pm2-add-panel').style.display = 'none';
      });
      document.getElementById('pm2-add-browse').addEventListener('click', function () {
        browseModalOpen('pm2-add-path');
      });
      document.getElementById('pm2-add-save-path').addEventListener('click', function () {
        var input = document.getElementById('pm2-add-path');
        var status = document.getElementById('pm2-add-path-status');
        status.textContent = 'Guardando...';
        status.className = 'status';
        fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reposPath: input.value.trim() })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              status.textContent = 'Guardado. Recargando lista‚Ä¶';
              status.className = 'status ok';
              document.getElementById('settings-repos-path').value = data.reposPath || '';
              pm2AddLoadRepos((data.reposPath || '').trim());
            } else {
              status.textContent = 'Error';
              status.className = 'status err';
            }
          })
          .catch(function () {
            status.textContent = 'Error de red';
            status.className = 'status err';
          });
      });

      document.getElementById('pm2-add-repo').addEventListener('change', function () {
        var path = this.value;
        var row = document.getElementById('pm2-add-scripts-row');
        var list = document.getElementById('pm2-add-scripts');
        list.innerHTML = '';
        document.getElementById('pm2-add-name-row').style.display = 'none';
        pm2Selected = { path: null, name: null, scriptName: null, scriptCommand: null };
        if (!path) {
          row.style.display = 'none';
          return;
        }
        var repo = pm2Repos.find(function (r) { return r.path === path; });
        if (!repo || !repo.scripts.length) {
          row.style.display = 'none';
          return;
        }
        repo.scripts.forEach(function (s) {
          var li = document.createElement('li');
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-small btn-edit pm2-script-btn';
          btn.textContent = s.name + ' (' + s.command + ')';
          btn.dataset.scriptName = s.name;
          btn.dataset.scriptCommand = s.command;
          btn.addEventListener('click', function () {
            list.querySelectorAll('.pm2-script-btn').forEach(function (b) { b.classList.remove('selected'); });
            btn.classList.add('selected');
            pm2Selected = { path: repo.path, name: repo.name, scriptName: s.name, scriptCommand: s.command };
            document.getElementById('pm2-add-name').value = repo.name;
            document.getElementById('pm2-add-name-row').style.display = 'block';
          });
          li.appendChild(btn);
          list.appendChild(li);
        });
        row.style.display = 'block';
      });

      document.getElementById('pm2-add-start-btn').addEventListener('click', function () {
        var statusTop = document.getElementById('pm2-status');
        var statusBtn = document.getElementById('pm2-add-status');
        function setMsg(msg, isErr) {
          statusTop.textContent = msg;
          statusTop.className = 'status ' + (isErr ? 'err' : '');
          statusBtn.textContent = msg;
          statusBtn.className = 'status ' + (isErr ? 'err' : '');
        }
        if (!pm2Selected.path || !pm2Selected.scriptCommand) {
          setMsg('Elige un proyecto y haz clic en un script (ej. start o dev)', true);
          return;
        }
        var name = document.getElementById('pm2-add-name').value.trim();
        if (!name) {
          setMsg('Indica el nombre del proceso', true);
          return;
        }
        setMsg('Arrancando...', false);
        var script = 'npm';
        var args = pm2Selected.scriptName === 'start' ? 'start' : ('run ' + pm2Selected.scriptName);
        fetch('/api/pm2/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name, cwd: pm2Selected.path, script: script, args: args })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              setMsg('Proceso arrancado', false);
              document.getElementById('pm2-add-panel').style.display = 'none';
              loadPM2List();
            } else {
              setMsg(data.error || 'Error', true);
            }
          })
          .catch(function (err) {
            setMsg('Error de red: ' + (err.message || 'desconocido'), true);
          });
      });

      loadPM2List();

      document.getElementById('btn-save-crontab').addEventListener('click', function () {
        var status = document.getElementById('save-status');
        status.textContent = 'Guardando...';
        status.className = 'status';
        fetch('/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobs: jobs.map(function (j) { return { schedule: j.schedule, command: j.command }; }) })
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              status.textContent = 'Crontab guardado correctamente';
              status.className = 'status ok';
              setTimeout(function () { location.reload(); }, 1200);
            } else {
              status.textContent = 'Error: ' + (data.error || 'desconocido');
              status.className = 'status err';
            }
          })
          .catch(function () {
            status.textContent = 'Error de red';
            status.className = 'status err';
          });
      });

      document.getElementById('job-form-panel').style.display = 'none';
      showFrequencyRows();

      // Buscador: resultados como tarjetas editables; al buscar solo se muestran esos resultados
      var searchInput = document.getElementById('search-input');
      var searchResults = document.getElementById('search-results');
      var searchVerTodas = document.getElementById('search-ver-todas');
      var scheduleSection = document.getElementById('schedule');
      var searchTimeout = null;
      var lastSearchResults = [];

      function renderSearchResultsFromData(results) {
        lastSearchResults = results || [];
        if (!results || results.length === 0) {
          searchResults.innerHTML = '<div class="no-results">No hay tareas que coincidan.</div>';
          searchVerTodas.style.display = 'none';
          if (scheduleSection) scheduleSection.style.display = 'block';
          return;
        }
        searchVerTodas.style.display = 'block';
        if (scheduleSection) scheduleSection.style.display = 'none';
        var html = '<p class="search-result-count">' + results.length + ' resultado' + (results.length !== 1 ? 's' : '') + '.</p><ul class="search-results-list">';
        results.forEach(function (r) {
          var idx = findJobIndex(r.schedule, r.command);
          if (idx < 0) return;
          var job = jobs[idx];
          html += '<li class="job-card">' + makeJobCard(job, idx) + '</li>';
        });
        html += '</ul>';
        searchResults.innerHTML = html;
        searchResults.querySelectorAll('[data-action="edit"]').forEach(function (btn) {
          btn.addEventListener('click', function () { openForm(parseInt(btn.getAttribute('data-index'), 10)); });
        });
        searchResults.querySelectorAll('[data-action="delete"]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-index'), 10);
            jobs.splice(i, 1);
            renderScheduleList();
            renderSearchResultsFromData(lastSearchResults.filter(function (r) { return findJobIndex(r.schedule, r.command) >= 0; }));
          });
        });
        searchResults.querySelectorAll('.job-log-view').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-index'), 10);
            if (i < 0 || !jobs[i]) return;
            var job = jobs[i];
            document.getElementById('log-modal-title').textContent = '\uD83D\uDCC4 Log de ejecuci√≥n';
            document.getElementById('log-modal-content').textContent = 'Cargando...';
            setLogModalMtime(null);
            document.getElementById('log-modal-overlay').style.display = 'block';
            document.getElementById('log-modal-overlay').setAttribute('aria-hidden', 'false');
            fetch('/api/jobs/log', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ schedule: job.schedule, command: job.command })
            }).then(function (r) { return r.json(); }).then(function (data) {
              document.getElementById('log-modal-content').textContent = data.ok ? data.content : (data.error || 'Error al cargar');
              setLogModalMtime(data);
            }).catch(function (err) {
              document.getElementById('log-modal-content').textContent = 'Error de red: ' + (err.message || 'desconocido');
              setLogModalMtime(null);
            });
          });
        });
        searchResults.querySelectorAll('.job-run-now').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var i = parseInt(btn.getAttribute('data-index'), 10);
            if (i < 0 || !jobs[i]) return;
            var job = jobs[i];
            btn.disabled = true;
            btn.textContent = 'Lanzando...';
            fetch('/api/jobs/run-now', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ schedule: job.schedule, command: job.command })
            }).then(function (r) { return r.json(); }).then(function (data) {
              btn.disabled = false;
              btn.textContent = 'Ejecuta';
              alert(data.ok ? (data.message || 'Ejecuci√≥n lanzada. Abre "Log" en unos segundos.') : (data.error || 'Error'));
            }).catch(function (err) {
              btn.disabled = false;
              btn.textContent = 'Ejecuta';
              alert('Error de red: ' + (err.message || 'desconocido'));
            });
          });
        });
      }

      function doSearch() {
        var q = searchInput.value.trim();
        if (q.length === 0) {
          searchResults.innerHTML = '';
          searchVerTodas.style.display = 'none';
          if (scheduleSection) scheduleSection.style.display = 'block';
          return;
        }
        searchResults.innerHTML = '<div class="search-hint">Buscando...</div>';
        fetch('/api/search?q=' + encodeURIComponent(q))
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) renderSearchResultsFromData(data.results);
            else searchResults.innerHTML = '<div class="no-results">Error al buscar.</div>';
          })
          .catch(function () { searchResults.innerHTML = '<div class="no-results">Error de red.</div>'; });
      }

      document.getElementById('btn-ver-todas').addEventListener('click', function () {
        searchInput.value = '';
        searchResults.innerHTML = '';
        searchVerTodas.style.display = 'none';
        if (scheduleSection) scheduleSection.style.display = 'block';
      });

      searchInput.addEventListener('input', function () {
        clearTimeout(searchTimeout);
        if (searchInput.value.trim().length === 0) {
          searchResults.innerHTML = '';
          searchVerTodas.style.display = 'none';
          if (scheduleSection) scheduleSection.style.display = 'block';
          return;
        }
        searchTimeout = setTimeout(doSearch, 280);
      });
      searchInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { e.preventDefault(); clearTimeout(searchTimeout); doSearch(); }
      });

      renderScheduleList();

      // Calendario: cargar ejecuciones del d√≠a seleccionado
      var dayViewDate = document.getElementById('day-view-date');
      var dayViewTimeline = document.getElementById('day-view-timeline');
      var dayViewStatus = document.getElementById('day-view-status');
      var dayViewNoRuns = document.getElementById('day-view-no-runs');
      function formatDateForInput(d) {
        var y = d.getFullYear();
        var m = String(d.getMonth() + 1).padStart(2, '0');
        var day = String(d.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + day;
      }
      if (dayViewDate && !dayViewDate.value) dayViewDate.value = formatDateForInput(new Date());
      function loadDayView() {
        var date = dayViewDate ? dayViewDate.value : formatDateForInput(new Date());
        if (!date) return;
        if (dayViewStatus) dayViewStatus.textContent = 'Cargando...';
        if (dayViewNoRuns) dayViewNoRuns.style.display = 'none';
        fetch('/api/jobs/day?date=' + encodeURIComponent(date))
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (dayViewStatus) dayViewStatus.textContent = '';
            if (!data.ok) {
              if (dayViewStatus) dayViewStatus.textContent = data.error || 'Error';
              return;
            }
            var slotsWithJobs = (data.slots || []).filter(function (s) { return s.jobs && s.jobs.length > 0; });
            if (slotsWithJobs.length === 0) {
              if (dayViewNoRuns) dayViewNoRuns.style.display = 'block';
              if (dayViewTimeline) dayViewTimeline.innerHTML = '';
              return;
            }
            if (dayViewNoRuns) dayViewNoRuns.style.display = 'none';
            var html = '<ul class="day-view-slots">';
            slotsWithJobs.forEach(function (slot) {
              var multiple = slot.jobs.length > 1;
              html += '<li class="day-view-slot' + (multiple ? ' day-view-slot--multiple' : '') + '">';
              html += '<div class="day-view-slot-time">' + escapeHtml(slot.time) + '</div>';
              html += '<ul class="day-view-slot-jobs">';
              slot.jobs.forEach(function (job) {
                var idx = findJobIndex(job.schedule, job.command);
                var canEdit = idx >= 0;
                var logStatus = (idx >= 0 && jobs[idx]) ? (jobs[idx].logStatus || 'unknown') : 'unknown';
                var logLabel = logStatus === 'ok' ? 'OK' : (logStatus === 'failed' ? 'Error' : 'Sin log');
                html += '<li class="day-view-job' + (canEdit ? ' day-view-job--clickable' : '') + '" data-job-index="' + (canEdit ? idx : -1) + '">';
                if (job.runTime) html += '<span class="day-view-job-time">' + escapeHtml(job.runTime) + '</span> ';
                html += '<span class="day-view-job-label">' + escapeHtml(job.humanCommand || job.command || job.humanSchedule || job.schedule) + '</span>';
                if (canEdit) {
                  html += '<span class="day-view-job-actions">';
                  html += '<span class="job-log-status job-log-status--' + logStatus + '" title="Estado">' + escapeHtml(logLabel) + '</span>';
                  html += '<button type="button" class="btn-small btn-edit day-view-job-log-view" data-job-index="' + idx + '" title="Ver log">Log</button> ';
                  html += '<button type="button" class="btn-small btn-primary day-view-job-run-now" data-job-index="' + idx + '" title="Ejecutar ahora">Ejecuta</button> ';
                  html += '<button type="button" class="btn-small btn-edit day-view-job-edit" data-job-index="' + idx + '" title="Editar tarea">Edita</button> ';
                  html += '<button type="button" class="btn-small btn-delete day-view-job-delete" data-job-index="' + idx + '" title="Eliminar tarea">Elimina</button>';
                  html += '</span>';
                }
                html += '</li>';
              });
              html += '</ul>';
              if (multiple) html += '<div class="day-view-slot-badge">' + slot.jobs.length + ' tareas</div>';
              html += '</li>';
            });
            html += '</ul>';
            if (dayViewTimeline) {
              dayViewTimeline.innerHTML = html;
              dayViewTimeline.querySelectorAll('.day-view-job-edit').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                  e.stopPropagation();
                  var i = parseInt(btn.getAttribute('data-job-index'), 10);
                  if (i >= 0) openForm(i);
                });
              });
              dayViewTimeline.querySelectorAll('.day-view-job-delete').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                  e.stopPropagation();
                  var i = parseInt(btn.getAttribute('data-job-index'), 10);
                  if (i >= 0) {
                    jobs.splice(i, 1);
                    renderScheduleList();
                    loadDayView();
                    if (typeof renderSearchResultsFromData === 'function' && document.getElementById('search-input').value.trim()) renderSearchResultsFromData(lastSearchResults);
                  }
                });
              });
              dayViewTimeline.querySelectorAll('.day-view-job-log-view').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                  e.stopPropagation();
                  var i = parseInt(btn.getAttribute('data-job-index'), 10);
                  if (i < 0 || !jobs[i]) return;
                  var job = jobs[i];
                  document.getElementById('log-modal-title').textContent = '\uD83D\uDCC4 Log de ejecuci√≥n';
                  document.getElementById('log-modal-content').textContent = 'Cargando...';
                  setLogModalMtime(null);
                  document.getElementById('log-modal-overlay').style.display = 'block';
                  document.getElementById('log-modal-overlay').setAttribute('aria-hidden', 'false');
                  fetch('/api/jobs/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule: job.schedule, command: job.command })
                  }).then(function (r) { return r.json(); }).then(function (data) {
                    document.getElementById('log-modal-content').textContent = data.ok ? data.content : (data.error || 'Error al cargar');
                    setLogModalMtime(data);
                  }).catch(function (err) {
                    document.getElementById('log-modal-content').textContent = 'Error de red: ' + (err.message || 'desconocido');
                    setLogModalMtime(null);
                  });
                });
              });
              dayViewTimeline.querySelectorAll('.day-view-job-run-now').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                  e.stopPropagation();
                  var i = parseInt(btn.getAttribute('data-job-index'), 10);
                  if (i < 0 || !jobs[i]) return;
                  var job = jobs[i];
                  btn.disabled = true;
                  btn.textContent = 'Lanzando...';
                  fetch('/api/jobs/run-now', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule: job.schedule, command: job.command })
                  }).then(function (r) { return r.json(); }).then(function (data) {
                    btn.disabled = false;
                    btn.textContent = 'Ejecuta';
                    alert(data.ok ? (data.message || 'Ejecuci√≥n lanzada. Abre "Log" en unos segundos.') : (data.error || 'Error'));
                  }).catch(function (err) {
                    btn.disabled = false;
                    btn.textContent = 'Ejecuta';
                    alert('Error de red: ' + (err.message || 'desconocido'));
                  });
                });
              });
            }
          })
          .catch(function (err) {
            if (dayViewStatus) dayViewStatus.textContent = 'Error de red: ' + (err.message || 'desconocido');
          });
      }
      if (dayViewDate) dayViewDate.addEventListener('change', loadDayView);
      loadDayView();
    })();
  </script>
</body>
</html>
